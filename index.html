    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const CONFIG = {
            SCRIPT_URL: "https://script.google.com/macros/s/AKfycbx59KU3Q7ariAEZdlVCahkHLJ6fRwaC-imwI9UI7Y0ULlaO1SIki_4zlsiVygdzE8HQ/exec",
            
            TEAMS: [
                "Email Support (Morning)", "Email Support (Evening)", "Email Support (VE)",
                "PSTF (Morning)", "PSTF (Evening)", "PSTF Night Shift", "PSTF VE Shift",
                "Morning Live chat (CFD)", "Evening Live Chat (CFD)", "CFD Live Chat Night Shift", "CFD Live chat VE",
                "Live chat Morning (Futures)", "Live Chat Evening (Futures)", "Live Chat Night Shift (Futures)", "Live chat VE (Futures)",
                "R&D"
            ],

            // AGENT MASTER LIST - Maps Teams to their specific Agents
            AGENT_MASTER_LIST: {
                "Email Support (Morning)": [
                    "Jerin Tasneem Prova (Jane Megan)", 
                    "Faiyaz Muhtasim Ahmed (Fredy Martinez)", 
                    "S. M. Sourav Sagor (Sandro Jerome)", 
                    "Izaz Ahmed Fuad (Jack Carter)", 
                    "Manish Sarkar (Tyson Mayne)"
                ],
                "Email Support (Evening)": [
                    "Abir Hassan Pial (William Grace)", 
                    "Nasrin Hossain Preya (Prina Isabella)", 
                    "Md. M Z Mahiduddin Shameem (Sammy Sage)", 
                    "Md. Rakib Hossain (Ricky Ron)", 
                    "M M Abir Ahmed Mugdho (Danny Archer)", 
                    "M I Fahim Alam (Ben Clark)"
                ],
                "Email Support (VE)": [
                    "MD Nayeem Hossain", 
                    "Nasif Ul Islam", 
                    "Sazzadul Haque Jony"
                ],
                "PSTF (Morning)": [
                    "Jerin Tasneem Prova (Jane Megan)", 
                    "Faiyaz Muhtasim Ahmed (Fredy Martinez)", 
                    "S. M. Sourav Sagor (Sandro Jerome)", 
                    "Izaz Ahmed Fuad (Jack Carter)", 
                    "Manish Sarkar (Tyson Mayne)"
                ],
                "PSTF (Evening)": [
                    "Abir Hassan Pial (William Grace)", 
                    "Nasrin Hossain Preya (Prina Isabella)", 
                    "Md. M Z Mahiduddin Shameem (Sammy Sage)", 
                    "Md. Rakib Hossain (Ricky Ron)", 
                    "M M Abir Ahmed Mugdho (Danny Archer)", 
                    "M I Fahim Alam (Ben Clark)"
                ],
                "PSTF Night Shift": [
                    "MD Nayeem Hossain"
                ],
                "PSTF VE Shift": [
                    "Nasif Ul Islam", 
                    "Sazzadul Haque Jony"
                ],
                "Morning Live chat (CFD)": [
                    "Md. Faisal Niyam (Lyra Lopez)", 
                    "Rakibul Hasan Remon (Grace Bexley)", 
                    "Ashraful Zannat (Skylar Maddison)", 
                    "Md. Zunaid (Penny Reed)", 
                    "Rakibul Islam (Samy Zayn)", 
                    "Marzahan Binte Sarker (Zofia Meier)", 
                    "Jake Devadason (Jay Walker)", 
                    "Shadrach Jayasinghe (Lian Carter)", 
                    "Jessica Dehodet (Emma Sinclair)", 
                    "Selena Leard"
                ],
                "Evening Live Chat (CFD)": [
                    "Tahseen Tayeb Kabir (Andrew Clarkson)", 
                    "Raiyan Ramin (Tom Matthew)", 
                    "Rumana Hossain Mow (Ruby Foster)", 
                    "Samik Ahmed Eshti (Jay Dawson)", 
                    "Nayema Nawshin Rahman Aroni (Annie Jan)", 
                    "Md. Tanjin Ul Hoque (Tazien Morgan)", 
                    "Rabit Al Hassan", 
                    "Ashraful Islam", 
                    "Rahat Rafsan", 
                    "Umme Salma Jui (Zara Monroe)", 
                    "Ashika Rahman (Ashley Stinson)", 
                    "Nushrat Hasan (Arya Blossom)", 
                    "Shaziq Hossain (Jeff Bloom)", 
                    "Nusrat Jahan Bidhe (Bella Calhoun)", 
                    "Rayan Alahakoon", 
                    "Sithil Waduge", 
                    "Darren Perera", 
                    "Ryan Patternot", 
                    "Matheesha Aswella"
                ],
                "CFD Live Chat Night Shift": [
                    "Tariqul Islam", 
                    "Rahat Rafsan", 
                    "Md. Rafi Hasan", 
                    "Md Obaidur Rahman Dip", 
                    "Fatin Farhan Juboraj", 
                    "Abdullah Al Jubair", 
                    "Rafi Bin Zahid"
                ],
                "CFD Live chat VE": [
                    "Elias Arman Bappi (Casey Cooper)", 
                    "Shaklain Mohammed Sifat (Thea Quinn)", 
                    "Maisha Mahzabeen Zaara (Katherine Pierce)", 
                    "Al-Zawad Islam Shadman (Selena Mercer)", 
                    "Riad Hasan Munsi (James Preston)", 
                    "Showmik Gaznabi"
                ],
                "Live chat Morning (Futures)": [
                    "Mobasshira Islam", 
                    "Sumic Maclean Gomes", 
                    "Pingkon Augustine Rozario", 
                    "Abidur Rahman (Mark Walter)", 
                    "Prince Zakaria", 
                    "Kithmal Wickramasingha"
                ],
                "Live Chat Evening (Futures)": [
                    "Meshak Abedin", 
                    "Janannt Ara (Nicky Brown)", 
                    "Dewan MD Rubayet Rafit", 
                    "Prince Zakaria", 
                    "Abishek Sasikumar", 
                    "Rizny Azmy"
                ],
                "Live Chat Night Shift (Futures)": [
                    "Sheikh Shahariar Shohag", 
                    "Shadib Hasan Anik", 
                    "MD Khalid Hasan", 
                    "Rifa Islam Prova", 
                    "Samiul Sakib Rafin", 
                    "Afifa Islam Fiha"
                ],
                "Live chat VE (Futures)": [
                    "Sheikh Shahariar Shohag", 
                    "Shadib Hasan Anik", 
                    "MD Khalid Hasan", 
                    "Rifa Islam Prova", 
                    "Samiul Sakib Rafin", 
                    "Afifa Islam Fiha", 
                    "Rajen Morshed Eida", 
                    "Md. Sadman", 
                    "Md Farhan Taher Oishik", 
                    "Sheikh Sajid Hasnain"
                ],
                "R&D": [
                    "Khaled Mahmud Sultan", 
                    "Mirza Moshirur Rahman Shizan", 
                    "Mir Sazzad Hossain", 
                    "Shahriar Hossain Sajol"
                ]
            }
        };

        // ==========================================
        // APP LOGIC
        // ==========================================
        const app = {
            state: {
                currentDate: new Date().toISOString().split('T')[0],
                currentTeam: null,
                currentAgent: null, // For leave modal
                adminMode: false
            },

            init() {
                // Set Date Picker
                document.getElementById('datePicker').value = this.state.currentDate;
                document.getElementById('datePicker').addEventListener('change', (e) => {
                    this.state.currentDate = e.target.value;
                    this.refreshData();
                });

                // Populate Admin Team Dropdown
                const teamSelect = document.getElementById('rosterTeam');
                CONFIG.TEAMS.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    teamSelect.appendChild(opt);
                });

                this.refreshData();
            },

            toggleAdmin() {
                this.state.adminMode = !this.state.adminMode;
                const panel = document.getElementById('adminPanel');
                const btn = document.getElementById('adminToggleBtn');
                
                if (this.state.adminMode) {
                    panel.classList.remove('hidden');
                    btn.textContent = "Exit Admin";
                    btn.classList.add('text-red-600');
                } else {
                    panel.classList.add('hidden');
                    btn.textContent = "Admin Mode";
                    btn.classList.remove('text-red-600');
                }
            },

            async refreshData() {
                this.showLoader(true);
                try {
                    const response = await fetch(`${CONFIG.SCRIPT_URL}?action=summary&date=${this.state.currentDate}`);
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    this.renderDashboard(data);
                } catch (err) {
                    console.error(err);
                    this.toast("Failed to load data", "error");
                } finally {
                    this.showLoader(false);
                }
            },

            renderDashboard(data) {
                const grid = document.getElementById('teamGrid');
                grid.innerHTML = '';
                
                if (data.teams.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }
                document.getElementById('emptyState').classList.add('hidden');

                data.teams.forEach(team => {
                    const isShortage = team.shortage;
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition cursor-pointer border-l-4 " + (isShortage ? "border-red-500" : "border-green-500");
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">${team.team}</h3>
                            <span class="text-xs font-semibold px-2 py-1 rounded ${isShortage ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${isShortage ? 'Shortage' : 'OK'}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Available</p>
                                <p class="text-2xl font-bold text-gray-900">${team.available}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Total / Req</p>
                                <p class="text-sm font-semibold text-gray-600">${team.total} <span class="text-gray-400">/ ${team.required}</span></p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between text-sm text-gray-500">
                            <span>Off: ${team.offDay}</span>
                            <span>Leave: ${team.onLeave}</span>
                        </div>
                    `;
                    
                    card.onclick = () => this.loadTeamDetails(team.team);
                    grid.appendChild(card);
                });
            },

            async loadTeamDetails(teamName) {
                this.showLoader(true);
                this.state.currentTeam = teamName;
                
                try {
                    const url = `${CONFIG.SCRIPT_URL}?action=teamDetails&date=${this.state.currentDate}&team=${encodeURIComponent(teamName)}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    
                    document.getElementById('modalTeamTitle').textContent = data.team;
                    const list = document.getElementById('agentList');
                    list.innerHTML = '';
                    
                    data.agents.forEach(agent => {
                        let statusBadge = '';
                        if (agent.onLeave) statusBadge = '<span class="ml-2 px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 text-xs">Leave</span>';
                        else if (agent.isOffDay) statusBadge = '<span class="ml-2 px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 text-xs">Off</span>';
                        
                        const li = document.createElement('li');
                        li.className = "py-3 flex justify-between items-center";
                        li.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-900">${agent.name} ${statusBadge}</p>
                                <p class="text-sm text-gray-500">${agent.shift || '--'}</p>
                            </div>
                            <button onclick="app.prepLeave('${agent.name}', '${agent.onLeave || ''}')" class="text-blue-600 text-sm hover:underline">
                                ${agent.onLeave ? 'Edit Leave' : '+ Leave'}
                            </button>
                        `;
                        list.appendChild(li);
                    });
                    
                    this.openModal('detailModal');
                } catch (err) {
                    this.toast("Error loading team details", "error");
                } finally {
                    this.showLoader(false);
                }
            },

            // --- Leave Management ---

            prepLeave(agentName, currentLeaveType) {
                this.state.currentAgent = agentName;
                document.getElementById('leaveTeam').value = this.state.currentTeam;
                document.getElementById('leaveAgentDisplay').value = agentName;
                document.getElementById('leaveAgentName').value = agentName;
                document.getElementById('leaveDate').value = this.state.currentDate;
                document.getElementById('leaveType').value = currentLeaveType || "Sick Leave";
                document.getElementById('leaveNotes').value = "";
                
                this.openModal('leaveModal');
            },

            async submitLeave() {
                this.showLoader(true);
                const payload = {
                    action: "addLeave",
                    date: document.getElementById('leaveDate').value,
                    team: document.getElementById('leaveTeam').value,
                    name: document.getElementById('leaveAgentName').value,
                    type: document.getElementById('leaveType').value,
                    notes: document.getElementById('leaveNotes').value
                };

                try {
                    const response = await fetch(CONFIG.SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    if (result.ok) {
                        this.toast("Leave added successfully");
                        this.closeModal('leaveModal');
                        // Refresh details
                        this.loadTeamDetails(this.state.currentTeam);
                        // Refresh dashboard background
                        this.refreshData();
                    } else {
                        throw new Error(result.error || "Unknown error");
                    }
                } catch (err) {
                    this.toast("Failed to add leave", "error");
                } finally {
                    this.showLoader(false);
                }
            },

            // --- Roster Edit (Admin) ---

            openRosterEditModal() {
                document.getElementById('rosterDate').value = this.state.currentDate;
                this.populateRosterAgents(); // Reset dropdowns
                this.openModal('rosterEditModal');
            },

            toggleShiftInput() {
                const isOff = document.getElementById('rosterIsOffDay').checked;
                const shiftInput = document.getElementById('rosterShift');
                shiftInput.disabled = isOff;
                if (isOff) shiftInput.value = "";
                shiftInput.classList.toggle('bg-gray-100', isOff);
            },

            populateRosterAgents() {
                const team = document.getElementById('rosterTeam').value;
                const agentSelect = document.getElementById('rosterAgent');
                agentSelect.innerHTML = '<option value="">Select Agent</option>';
                
                if (!team) return;

                // Use the hardcoded master list to populate dropdown immediately
                // This allows adding data for the first time even if Sheet is empty
                const agents = CONFIG.AGENT_MASTER_LIST[team];

                if (agents) {
                    agents.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        agentSelect.appendChild(opt);
                    });
                } else {
                    const opt = document.createElement('option');
                    opt.textContent = "No agents defined in config";
                    agentSelect.appendChild(opt);
                }
            },

            async submitRosterUpdate() {
                this.showLoader(true);
                const payload = {
                    action: "updateRoster",
                    date: document.getElementById('rosterDate').value,
                    team: document.getElementById('rosterTeam').value,
                    name: document.getElementById('rosterAgent').value,
                    isOffDay: document.getElementById('rosterIsOffDay').checked,
                    shift: document.getElementById('rosterShift').value
                };

                try {
                    const res = await fetch(CONFIG.SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    
                    if (data.ok) {
                        this.toast("Roster updated");
                        this.closeModal('rosterEditModal');
                        this.refreshData();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (err) {
                    this.toast("Update failed", "error");
                } finally {
                    this.showLoader(false);
                }
            },

            // --- UI Helpers ---

            openModal(id) {
                document.getElementById(id).classList.remove('hidden');
            },
            closeModal(id) {
                document.getElementById(id).classList.add('hidden');
            },
            showLoader(show) {
                const el = document.getElementById('loaderOverlay');
                if (show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            },
            toast(msg, type='success') {
                const el = document.getElementById('toast');
                const txt = document.getElementById('toastMessage');
                txt.textContent = msg;
                el.className = `fixed bottom-4 right-4 px-6 py-3 rounded shadow-lg transform transition-all duration-300 z-50 flex items-center gap-3 ${type === 'error' ? 'bg-red-600' : 'bg-slate-800'} text-white translate-y-0 opacity-100`;
                
                setTimeout(() => {
                    el.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }
        };

        // Boot
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
