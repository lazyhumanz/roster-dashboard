<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEx Roster Dashboard</title>
    <!-- Tailwind CSS via CDN (for development) -->
    <!-- For production, consider using Tailwind CLI or PostCSS -->
    <script>
        // Suppress Tailwind CDN warning
        if (typeof console !== 'undefined' && console.warn) {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                    return; // Suppress Tailwind CDN warning
                }
                originalWarn.apply(console, args);
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark Theme */
        body {
            background: #0f172a;
            color: #ffffff;
        }
        
        /* Custom Utilities */
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        /* Spinner Animation */
        .loader {
            border: 4px solid #1e293b;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px; height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar for agent list */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Card border accent */
        .card-border-ok { border-left: 4px solid #10b981; }
        .card-border-shortage { border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans min-h-screen">

    <!-- Loading Overlay -->
    <div id="loaderOverlay" class="fixed inset-0 bg-slate-900/80 z-50 flex flex-col items-center justify-center hidden">
        <div class="loader mb-4"></div>
        <div id="loaderText" class="font-bold text-blue-400">Loading Data...</div>
    </div>

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-green-500 text-white p-2 rounded-full">
                    <span class="text-lg font-bold">R</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">CEx Roster Dashboard</h1>
                    <p class="text-sm text-slate-400">Team availability & management</p>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <div class="relative">
                    <div class="flex items-center gap-2 bg-slate-700 px-4 py-2 rounded-lg cursor-pointer hover:bg-slate-600 transition" onclick="app.toggleCalendar(event)">
                        <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span id="dateDisplay" class="text-sm text-white font-medium"></span>
                        <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <!-- Calendar Dropdown -->
                    <div id="calendarDropdown" class="hidden absolute top-full right-0 mt-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 p-4 min-w-[280px]" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="event.stopPropagation(); app.changeCalendarMonth(-1)" class="p-1 text-slate-300 hover:text-white hover:bg-slate-700 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <h3 id="calendarMonthYear" class="text-white font-semibold"></h3>
                            <button onclick="event.stopPropagation(); app.changeCalendarMonth(1)" class="p-1 text-slate-300 hover:text-white hover:bg-slate-700 rounded">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div class="text-center text-xs text-slate-400 font-medium py-1">Sun</div>
                            <div class="text-center text-xs text-slate-400 font-medium py-1">Mon</div>
                            <div class="text-center text-xs text-slate-400 font-medium py-1">Tue</div>
                            <div class="text-center text-xs text-slate-400 font-medium py-1">Wed</div>
                            <div class="text-center text-xs text-slate-400 font-medium py-1">Thu</div>
                            <div class="text-center text-xs text-slate-400 font-medium py-1">Fri</div>
                            <div class="text-center text-xs text-slate-400 font-medium py-1">Sat</div>
                        </div>
                        <div id="calendarDays" class="grid grid-cols-7 gap-1"></div>
                    </div>
                </div>
                <button onclick="app.refreshData()" class="p-2 text-slate-300 hover:text-white hover:bg-slate-700 rounded transition" title="Refresh">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
                <input type="date" id="datePicker" class="hidden">
            </div>
            
            <div>
                <button id="adminToggleBtn" onclick="app.toggleAdmin()" class="px-4 py-2 bg-slate-700 text-white text-sm rounded-lg hover:bg-slate-600 font-medium flex items-center gap-2 transition">
                    <span id="adminToggleIcon">üõ°Ô∏è</span>
                    <span id="adminToggleText">Admin Mode</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Admin Controls (Hidden by default) -->
        <div id="adminPanel" class="hidden mb-6 bg-slate-800 border border-slate-700 p-6 rounded-xl fade-in">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <h3 class="font-bold text-white text-lg">Admin Controls</h3>
            </div>
                <button onclick="app.toggleAdmin()" class="text-xs text-slate-400 hover:text-white underline">Close</button>
            </div>
            <p class="text-sm text-slate-400 mb-4">Manage roster, leaves, and agents</p>
            <div class="flex gap-3 flex-wrap">
                <button onclick="app.openLeaveUpdateModal()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700 font-medium shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Add/Update Leave
                </button>
                <button onclick="app.openLeaveListModal()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700 font-medium shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    View All Leaves
                </button>
                <button onclick="app.showPasswordModal('updateRoster')" class="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-amber-700 font-medium shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Update Roster
                </button>
                <button onclick="app.showPasswordModal('manageAgents')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 font-medium shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    Manage Agents
                </button>
                <button id="refreshFormulasBtn" onclick="app.showPasswordModal('refreshFormulas')" class="bg-slate-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-slate-700 font-medium shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Refresh Formulas
                </button>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div id="summaryStats" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-slate-700 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Total Available Agent</p>
                        <p id="statTotalAgents" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-green-500/20 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Teams OK</p>
                        <p id="statTeamsOK" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-red-500/20 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Shortages</p>
                        <p id="statShortages" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-amber-500/20 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Coverage</p>
                        <p id="statCoverage" class="text-2xl font-bold text-white">0%</p>
                    </div>
                </div>
            </div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-orange-500/20 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-400">Total Agent on Leave</p>
                        <p id="statTotalOnLeave" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Cards Grid -->
        <div id="teamGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards Injected Here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-20">
            <div class="inline-block p-4 rounded-full bg-slate-800 mb-4">
                <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            </div>
            <p class="text-slate-300 text-lg font-medium">No roster data found for this date.</p>
            <p class="text-slate-500 text-sm mt-1">Try a different date or use Admin Mode to add data.</p>
        </div>
    </main>

    <!-- Modals -->

    <!-- 1. Team Detail Modal -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="app.closeModal('detailModal')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-slate-800 border border-slate-700 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full fade-in">
                <div class="bg-slate-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start justify-between mb-4">
                        <h3 class="text-lg leading-6 font-medium text-white" id="modalTeamTitle">Team Name</h3>
                        <button onclick="app.closeModal('detailModal')" class="text-slate-400 hover:text-white focus:outline-none">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div class="max-h-[60vh] overflow-y-auto custom-scroll">
                        <ul id="agentList" class="divide-y divide-slate-700">
                            <!-- Agent Rows -->
                        </ul>
                    </div>
                </div>
                <div class="bg-slate-800 border-t border-slate-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="app.closeModal('detailModal')" class="w-full inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-white hover:bg-slate-600 sm:w-auto sm:text-sm">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Leave Modal -->
    <div id="leaveModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="app.closeModal('leaveModal')"></div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl transform transition-all max-w-md w-full p-6 relative z-10 fade-in">
                <h3 id="leaveModalTitle" class="text-xl font-bold mb-4 text-white">Apply Leave</h3>
                <form id="leaveForm" onsubmit="event.preventDefault(); app.submitLeave();">
                    <input type="hidden" id="leaveTeam">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Agent</label>
                        <input type="text" id="leaveAgentDisplay" readonly class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white">
                        <input type="hidden" id="leaveAgentName">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Select Dates (Multiple)</label>
                        <div class="relative">
                            <div id="leaveDateDisplay" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white cursor-pointer" onclick="app.toggleLeaveCalendar()">
                                <span id="leaveDateText">Click to select dates</span>
                                <span class="float-right">üìÖ</span>
                            </div>
                            <div id="leaveCalendarContainer" class="hidden absolute z-20 mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-4 w-80">
                                <div class="flex justify-between items-center mb-4">
                                    <button type="button" onclick="app.changeLeaveCalendarMonth(-1)" class="text-slate-300 hover:text-white">‚Üê</button>
                                    <h4 id="leaveCalendarMonthYear" class="text-white font-semibold"></h4>
                                    <button type="button" onclick="app.changeLeaveCalendarMonth(1)" class="text-slate-300 hover:text-white">‚Üí</button>
                                </div>
                                <div id="leaveCalendar" class="grid grid-cols-7 gap-1"></div>
                                <div class="mt-4 pt-4 border-t border-slate-600">
                                    <div class="text-sm text-slate-300 mb-2">Selected Dates:</div>
                                    <div id="leaveSelectedDates" class="flex flex-wrap gap-2 min-h-[2rem]"></div>
                                    <button type="button" onclick="app.clearLeaveDates()" class="mt-2 text-sm text-red-400 hover:text-red-300">Clear All</button>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="leaveDates" value="">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Leave Type</label>
                        <select id="leaveType" onchange="app.handleLeaveTypeChange()" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white">
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Casual Leave">Casual Leave</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Full Day">Full Day</option>
                            <option value="Half Day">Half Day</option>
                        </select>
                    </div>
                    <div id="halfDayOptionContainer" class="mb-4 hidden">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Half Day Option</label>
                        <select id="halfDayOption" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white">
                            <option value="1st Half">1st Half</option>
                            <option value="2nd Half">2nd Half</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Notes (Optional)</label>
                        <textarea id="leaveNotes" rows="3" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white"></textarea>
                    </div>
                    <div class="flex justify-between gap-2">
                        <div>
                            <button type="button" id="cancelLeaveBtn" onclick="app.cancelLeave()" class="hidden px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 shadow-sm">Cancel Leave</button>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick="app.closeModal('leaveModal')" class="px-4 py-2 border border-slate-600 rounded text-slate-300 hover:bg-slate-700">Close</button>
                            <button type="submit" id="leaveSubmitBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm">Submit</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 3. Roster Edit Modal (Admin) -->
    <div id="rosterEditModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 py-4">
            <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="app.closeModal('rosterEditModal')"></div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl transform transition-all max-w-2xl w-full p-6 relative z-10 fade-in max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4 text-amber-400">Update Roster Entry - Team Change</h3>
                <p class="text-xs text-slate-400 mb-4">Change agent's team temporarily or permanently with shift updates.</p>
                <form id="rosterForm" onsubmit="event.preventDefault(); app.submitRosterUpdate();">
                    <!-- Current Team and Agent Selection -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Current Team</label>
                            <select id="rosterTeam" onchange="app.populateRosterAgents()" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                                <option value="">Select Team</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Agent</label>
                            <select id="rosterAgent" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                                <option value="">Select Team First</option>
                            </select>
                        </div>
                    </div>

                    <!-- Change Type Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Change Type</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="changeType" value="temporary" onchange="app.toggleChangeType()" checked class="w-4 h-4 text-amber-600 focus:ring-amber-500 border-slate-600 bg-slate-700">
                                <span class="text-sm font-medium text-slate-300">Temporary</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="changeType" value="permanent" onchange="app.toggleChangeType()" class="w-4 h-4 text-amber-600 focus:ring-amber-500 border-slate-600 bg-slate-700">
                                <span class="text-sm font-medium text-slate-300">Permanent</span>
                            </label>
                        </div>
                    </div>

                    <!-- Temporary Change Fields -->
                    <div id="temporaryFields" class="mb-4 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-1">From Date</label>
                                <input type="date" id="rosterFromDate" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-1">To Date</label>
                                <input type="date" id="rosterToDate" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Assign to New Team</label>
                            <select id="rosterNewTeam" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                                <option value="">Select New Team</option>
                        </select>
                    </div>
                    </div>

                    <!-- Permanent Change Fields -->
                    <div id="permanentFields" class="mb-4 hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Starting Date</label>
                            <input type="date" id="rosterStartDate" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Assign to New Team (Optional - leave empty to keep same team)</label>
                            <select id="rosterPermanentNewTeam" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                                <option value="">Keep Current Team</option>
                            </select>
                        </div>
                    </div>

                    <!-- Shift Time Selection (Block Format) -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Shift Time</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <button type="button" onclick="app.selectShiftTime('7:15AM-4:15PM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">7:15AM-4:15PM</button>
                            <button type="button" onclick="app.selectShiftTime('8:00AM-5:00PM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">8:00AM-5:00PM</button>
                            <button type="button" onclick="app.selectShiftTime('8:30AM-5:30PM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">8:30AM-5:30PM</button>
                            <button type="button" onclick="app.selectShiftTime('9:00AM-6:00PM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">9:00AM-6:00PM</button>
                            <button type="button" onclick="app.selectShiftTime('1:15PM-9:45PM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">1:15PM-9:45PM</button>
                            <button type="button" onclick="app.selectShiftTime('2:00PM-11:00PM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">2:00PM-11:00PM</button>
                            <button type="button" onclick="app.selectShiftTime('6:00PM-11:00PM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">6:00PM-11:00PM</button>
                            <button type="button" onclick="app.selectShiftTime('9:30PM-2:40AM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">9:30PM-2:40AM</button>
                            <button type="button" onclick="app.selectShiftTime('10:30PM-7:30AM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">10:30PM-7:30AM</button>
                            <button type="button" onclick="app.selectShiftTime('2:20AM-7:30AM', this)" class="px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-amber-600 hover:text-white hover:border-amber-500 transition">2:20AM-7:30AM</button>
                        </div>
                        <input type="text" id="rosterShift" placeholder="Or enter custom shift time (e.g. 9:00AM-6:00PM)" class="w-full border border-slate-600 rounded p-2 mt-2 bg-slate-700 text-white placeholder-slate-500 focus:ring-amber-500 focus:border-amber-500">
                    </div>

                    <!-- Day Off Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Day Off (Select 2 days per week)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Day Off One</label>
                                <select id="rosterDayOffOne" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                                    <option value="">Select Day</option>
                                    <option value="Sunday">Sunday</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Day Off Two</label>
                                <select id="rosterDayOffTwo" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500">
                                    <option value="">Select Day</option>
                                    <option value="Sunday">Sunday</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 pt-4 border-t border-slate-700">
                        <button type="button" onclick="app.closeModal('rosterEditModal')" class="px-4 py-2 border border-slate-600 rounded text-slate-300 hover:bg-slate-700">Cancel</button>
                        <button type="submit" id="rosterSubmitBtn" class="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 shadow-sm">Update Roster</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 4. Leave Update Modal (Admin) -->
    <div id="leaveUpdateModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="app.closeModal('leaveUpdateModal')"></div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl transform transition-all max-w-md w-full p-6 relative z-10 fade-in">
                <h3 class="text-xl font-bold mb-4 text-teal-400">Add/Update Leave</h3>
                <form id="leaveUpdateForm" onsubmit="event.preventDefault(); app.submitLeaveUpdate();">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Team</label>
                        <select id="leaveUpdateTeam" onchange="app.populateLeaveUpdateAgents()" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-teal-500 focus:border-teal-500">
                            <option value="">Select Team</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Agent</label>
                        <select id="leaveUpdateAgent" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-teal-500 focus:border-teal-500">
                            <option value="">Select Team First</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Select Dates (Multiple)</label>
                        <div class="relative">
                            <div id="leaveUpdateDateDisplay" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white cursor-pointer" onclick="app.toggleLeaveUpdateCalendar()">
                                <span id="leaveUpdateDateText">Click to select dates</span>
                                <span class="float-right">üìÖ</span>
                            </div>
                            <div id="leaveUpdateCalendarContainer" class="hidden absolute z-20 mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-4 w-80">
                                <div class="flex justify-between items-center mb-4">
                                    <button type="button" onclick="app.changeLeaveUpdateCalendarMonth(-1)" class="text-slate-300 hover:text-white">‚Üê</button>
                                    <h4 id="leaveUpdateCalendarMonthYear" class="text-white font-semibold"></h4>
                                    <button type="button" onclick="app.changeLeaveUpdateCalendarMonth(1)" class="text-slate-300 hover:text-white">‚Üí</button>
                                </div>
                                <div id="leaveUpdateCalendar" class="grid grid-cols-7 gap-1"></div>
                                <div class="mt-4 pt-4 border-t border-slate-600">
                                    <div class="text-sm text-slate-300 mb-2">Selected Dates:</div>
                                    <div id="leaveUpdateSelectedDates" class="flex flex-wrap gap-2 min-h-[2rem]"></div>
                                    <button type="button" onclick="app.clearLeaveUpdateDates()" class="mt-2 text-sm text-red-400 hover:text-red-300">Clear All</button>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="leaveUpdateDates" value="">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Leave Type</label>
                        <select id="leaveUpdateType" onchange="app.handleLeaveUpdateTypeChange()" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white">
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Casual Leave">Casual Leave</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Full Day">Full Day</option>
                            <option value="Half Day">Half Day</option>
                        </select>
                    </div>
                    <div id="halfDayUpdateOptionContainer" class="mb-4 hidden">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Half Day Option</label>
                        <select id="halfDayUpdateOption" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white">
                            <option value="1st Half">1st Half</option>
                            <option value="2nd Half">2nd Half</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Notes (Optional)</label>
                        <textarea id="leaveUpdateNotes" rows="3" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white"></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="app.closeModal('leaveUpdateModal')" class="px-4 py-2 border border-slate-600 rounded text-slate-300 hover:bg-slate-700">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 shadow-sm">Save Leave</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 5. Password Authentication Modal -->
    <div id="passwordModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="app.closeModal('passwordModal')"></div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl transform transition-all max-w-md w-full p-6 relative z-10 fade-in">
                <h3 class="text-xl font-bold mb-4 text-amber-400">Admin Authentication Required</h3>
                <p class="text-sm text-slate-400 mb-4">Please enter your email and password to continue.</p>
                <form id="passwordForm" onsubmit="event.preventDefault(); app.submitPassword();">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Email</label>
                        <input type="email" id="adminEmail" required class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500" placeholder="Enter your email">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Password</label>
                        <input type="password" id="adminPassword" required class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-amber-500 focus:border-amber-500" placeholder="Enter your password">
                    </div>
                    <div id="passwordError" class="mb-4 hidden text-red-400 text-sm"></div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="app.closeModal('passwordModal')" class="px-4 py-2 border border-slate-600 rounded text-slate-300 hover:bg-slate-700">Cancel</button>
                        <button type="submit" id="passwordSubmitBtn" class="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 shadow-sm">Authenticate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 6. Leave List Modal (Admin) -->
    <div id="leaveListModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="app.closeModal('leaveListModal')"></div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl transform transition-all max-w-3xl w-full p-6 relative z-10 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-teal-400">View/Delete Leaves</h3>
                    <button onclick="app.closeModal('leaveListModal')" class="text-slate-400 hover:text-white">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-300 mb-1">Filter by Date</label>
                    <input type="date" id="leaveListDate" onchange="app.loadLeaveList()" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white">
                </div>
                <div class="max-h-[60vh] overflow-y-auto custom-scroll">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase">Team</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase">Agent</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leaveListBody" class="bg-slate-800 divide-y divide-slate-700">
                            <tr>
                                <td colspan="5" class="px-4 py-4 text-center text-slate-400">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Add/Remove Agent Modal (Admin) -->
    <div id="agentManageModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="app.closeModal('agentManageModal')"></div>
            <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl transform transition-all max-w-2xl w-full p-6 relative z-10 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-green-400">Add/Remove Agent</h3>
                    <button onclick="app.closeModal('agentManageModal')" class="text-slate-400 hover:text-white">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <!-- Tabs for Add/Remove -->
                <div class="mb-4 border-b border-slate-700">
                    <div class="flex gap-4">
                        <button onclick="app.switchAgentTab('add')" id="agentAddTab" class="px-4 py-2 font-medium text-sm border-b-2 border-green-500 text-green-400">Add Agent</button>
                        <button onclick="app.switchAgentTab('remove')" id="agentRemoveTab" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-600">Remove Agent</button>
                    </div>
                </div>

                <!-- Add Agent Form -->
                <div id="addAgentForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Team</label>
                        <select id="addAgentTeam" onchange="app.loadExistingAgents()" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-green-500 focus:border-green-500">
                            <option value="">Select Team</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Agent Name</label>
                        <input type="text" id="addAgentName" placeholder="Enter agent full name" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white placeholder-slate-500 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Default Shift Time</label>
                        <input type="text" id="addAgentShift" placeholder="e.g. 9:00AM-6:00PM" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white placeholder-slate-500 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Select Weekend Days (Off Days)</label>
                        <div class="grid grid-cols-7 gap-2">
                            <button type="button" onclick="app.toggleWeekendDay('Sunday', this)" class="weekend-day-btn px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-green-600 hover:text-white transition" data-day="Sunday">Sun</button>
                            <button type="button" onclick="app.toggleWeekendDay('Monday', this)" class="weekend-day-btn px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-green-600 hover:text-white transition" data-day="Monday">Mon</button>
                            <button type="button" onclick="app.toggleWeekendDay('Tuesday', this)" class="weekend-day-btn px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-green-600 hover:text-white transition" data-day="Tuesday">Tue</button>
                            <button type="button" onclick="app.toggleWeekendDay('Wednesday', this)" class="weekend-day-btn px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-green-600 hover:text-white transition" data-day="Wednesday">Wed</button>
                            <button type="button" onclick="app.toggleWeekendDay('Thursday', this)" class="weekend-day-btn px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-green-600 hover:text-white transition" data-day="Thursday">Thu</button>
                            <button type="button" onclick="app.toggleWeekendDay('Friday', this)" class="weekend-day-btn px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-green-600 hover:text-white transition" data-day="Friday">Fri</button>
                            <button type="button" onclick="app.toggleWeekendDay('Saturday', this)" class="weekend-day-btn px-3 py-2 border border-slate-600 rounded text-sm bg-slate-700 text-slate-300 hover:bg-green-600 hover:text-white transition" data-day="Saturday">Sat</button>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Click on days to mark them as off days (weekends)</p>
                    </div>
                    <div class="flex justify-end gap-2 pt-4 border-t border-slate-700">
                        <button type="button" onclick="app.closeModal('agentManageModal')" class="px-4 py-2 border border-slate-600 rounded text-slate-300 hover:bg-slate-700">Cancel</button>
                        <button type="button" onclick="app.addAgent()" id="addAgentBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 shadow-sm">Add Agent</button>
                    </div>
                </div>

                <!-- Remove Agent Form -->
                <div id="removeAgentForm" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Team</label>
                        <select id="removeAgentTeam" onchange="app.loadAgentsForRemoval()" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-red-500 focus:border-red-500">
                            <option value="">Select Team</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Agent</label>
                        <select id="removeAgentName" class="w-full border border-slate-600 rounded p-2 bg-slate-700 text-white focus:ring-red-500 focus:border-red-500">
                            <option value="">Select Team First</option>
                        </select>
                    </div>
                    <div class="bg-red-500/20 border border-red-500/50 rounded p-3">
                        <p class="text-sm text-red-400">‚ö†Ô∏è Warning: Removing an agent will delete their row from the roster sheet. This action cannot be undone.</p>
                    </div>
                    <div class="flex justify-end gap-2 pt-4 border-t border-slate-700">
                        <button type="button" onclick="app.closeModal('agentManageModal')" class="px-4 py-2 border border-slate-600 rounded text-slate-300 hover:bg-slate-700">Cancel</button>
                        <button type="button" onclick="app.removeAgent()" id="removeAgentBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 shadow-sm">Remove Agent</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <span id="toastMessage">Notification</span>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const CONFIG = {
            // PASTE YOUR WEB APP URL HERE
            SCRIPT_URL: "https://script.google.com/macros/s/AKfycbx59KU3Q7ariAEZdlVCahkHLJ6fRwaC-imwI9UI7Y0ULlaO1SIki_4zlsiVygdzE8HQ/exec",
            
            TEAMS: [
                "Email Support (Morning)", "Email Support (Evening)", "Email Support (VE)",
                "PSTF (Morning)", "PSTF (Evening)", "PSTF Night Shift", "PSTF VE Shift",
                "Morning Live chat (CFD)", "Evening Live Chat (CFD)", "CFD Live Chat Night Shift", "CFD Live chat VE",
                "Live chat Morning (Futures)", "Live Chat Evening (Futures)", "Live Chat Night Shift (Futures)", "Live chat VE (Futures)",
                "R&D"
            ],

            // AGENT MASTER LIST - Specific agents provided by user
            AGENT_MASTER_LIST: {
                "Email Support (Morning)": [
                    "Jerin Tasneem Prova (Jane Megan)", 
                    "Faiyaz Muhtasim Ahmed (Fredy Martinez)", 
                    "S. M. Sourav Sagor (Sandro Jerome)", 
                    "Izaz Ahmed Fuad (Jack Carter)", 
                    "Manish Sarkar (Tyson Mayne)"
                ],
                "Email Support (Evening)": [
                    "Abir Hassan Pial (William Grace)", 
                    "Nasrin Hossain Preya (Prina Isabella)", 
                    "Md. M Z Mahiduddin Shameem (Sammy Sage)", 
                    "Md. Rakib Hossain (Ricky Ron)", 
                    "M M Abir Ahmed Mugdho (Danny Archer)", 
                    "M I Fahim Alam (Ben Clark)"
                ],
                "Email Support (VE)": [
                    "MD Nayeem Hossain", 
                    "Nasif Ul Islam", 
                    "Sazzadul Haque Jony"
                ],
                "PSTF (Morning)": [
                    "Jerin Tasneem Prova (Jane Megan)", 
                    "Faiyaz Muhtasim Ahmed (Fredy Martinez)", 
                    "S. M. Sourav Sagor (Sandro Jerome)", 
                    "Izaz Ahmed Fuad (Jack Carter)", 
                    "Manish Sarkar (Tyson Mayne)"
                ],
                "PSTF (Evening)": [
                    "Abir Hassan Pial (William Grace)", 
                    "Nasrin Hossain Preya (Prina Isabella)", 
                    "Md. M Z Mahiduddin Shameem (Sammy Sage)", 
                    "Md. Rakib Hossain (Ricky Ron)", 
                    "M M Abir Ahmed Mugdho (Danny Archer)", 
                    "M I Fahim Alam (Ben Clark)"
                ],
                "PSTF Night Shift": [
                    "MD Nayeem Hossain"
                ],
                "PSTF VE Shift": [
                    "Nasif Ul Islam", 
                    "Sazzadul Haque Jony"
                ],
                "Morning Live chat (CFD)": [
                    "Md. Faisal Niyam (Lyra Lopez)", 
                    "Rakibul Hasan Remon (Grace Bexley)", 
                    "Ashraful Zannat (Skylar Maddison)", 
                    "Md. Zunaid (Penny Reed)", 
                    "Rakibul Islam (Samy Zayn)", 
                    "Marzahan Binte Sarker (Zofia Meier)", 
                    "Jake Devadason (Jay Walker)", 
                    "Shadrach Jayasinghe (Lian Carter)", 
                    "Jessica Dehodet (Emma Sinclair)", 
                    "Selena Leard"
                ],
                "Evening Live Chat (CFD)": [
                    "Tahseen Tayeb Kabir (Andrew Clarkson)", 
                    "Raiyan Ramin (Tom Matthew)", 
                    "Rumana Hossain Mow (Ruby Foster)", 
                    "Samik Ahmed Eshti (Jay Dawson)", 
                    "Nayema Nawshin Rahman Aroni (Annie Jan)", 
                    "Md. Tanjin Ul Hoque (Tazien Morgan)", 
                    "Rabit Al Hassan", 
                    "Ashraful Islam", 
                    "Rahat Rafsan", 
                    "Umme Salma Jui (Zara Monroe)", 
                    "Ashika Rahman (Ashley Stinson)", 
                    "Nushrat Hasan (Arya Blossom)", 
                    "Shaziq Hossain (Jeff Bloom)", 
                    "Nusrat Jahan Bidhe (Bella Calhoun)", 
                    "Rayan Alahakoon", 
                    "Sithil Waduge", 
                    "Darren Perera", 
                    "Ryan Patternot", 
                    "Matheesha Aswella"
                ],
                "CFD Live Chat Night Shift": [
                    "Tariqul Islam", 
                    "Rahat Rafsan", 
                    "Md. Rafi Hasan", 
                    "Md Obaidur Rahman Dip", 
                    "Fatin Farhan Juboraj", 
                    "Abdullah Al Jubair", 
                    "Rafi Bin Zahid"
                ],
                "CFD Live chat VE": [
                    "Elias Arman Bappi (Casey Cooper)", 
                    "Shaklain Mohammed Sifat (Thea Quinn)", 
                    "Maisha Mahzabeen Zaara (Katherine Pierce)", 
                    "Al-Zawad Islam Shadman (Selena Mercer)", 
                    "Riad Hasan Munsi (James Preston)", 
                    "Showmik Gaznabi"
                ],
                "Live chat Morning (Futures)": [
                    "Mobasshira Islam", 
                    "Sumic Maclean Gomes", 
                    "Pingkon Augustine Rozario", 
                    "Abidur Rahman (Mark Walter)", 
                    "Prince Zakaria", 
                    "Kithmal Wickramasingha"
                ],
                "Live Chat Evening (Futures)": [
                    "Meshak Abedin", 
                    "Janannt Ara (Nicky Brown)", 
                    "Dewan MD Rubayet Rafit", 
                    "Prince Zakaria", 
                    "Abishek Sasikumar", 
                    "Rizny Azmy"
                ],
                "Live Chat Night Shift (Futures)": [
                    "Sheikh Shahariar Shohag", 
                    "Shadib Hasan Anik", 
                    "MD Khalid Hasan", 
                    "Rifa Islam Prova", 
                    "Samiul Sakib Rafin", 
                    "Afifa Islam Fiha"
                ],
                "Live chat VE (Futures)": [
                    "Sheikh Shahariar Shohag", 
                    "Shadib Hasan Anik", 
                    "MD Khalid Hasan", 
                    "Rifa Islam Prova", 
                    "Samiul Sakib Rafin", 
                    "Afifa Islam Fiha", 
                    "Rajen Morshed Eida", 
                    "Md. Sadman", 
                    "Md Farhan Taher Oishik", 
                    "Sheikh Sajid Hasnain"
                ],
                "R&D": [
                    "Khaled Mahmud Sultan", 
                    "Mirza Moshirur Rahman Shizan", 
                    "Mir Sazzad Hossain", 
                    "Shahriar Hossain Sajol"
                ]
            }
        };

        // ==========================================
        // APP LOGIC
        // ==========================================
        const app = {
            state: {
                currentDate: new Date().toISOString().split('T')[0],
                currentTeam: null,
                currentAgent: null, // For leave modal
                adminMode: false,
                isEditingLeave: false, // Track if editing existing leave
                adminEmail: null, // Store authenticated admin email
                adminPassword: null, // Store authenticated admin password
                pendingAction: null // Store action to perform after authentication
            },

            init() {
                // Set Date Picker
                const datePicker = document.getElementById('datePicker');
                datePicker.value = this.state.currentDate;
                
                // Update date display initially
                this.updateDateDisplay();
                
                datePicker.addEventListener('change', (e) => {
                    this.state.currentDate = e.target.value;
                    this.updateDateDisplay();
                    this.refreshData();
                });

                // Bind closeCalendarOnOutsideClick to app context
                this.closeCalendarOnOutsideClick = this.closeCalendarOnOutsideClick.bind(this);
                // Bind closeLeaveCalendarOnOutsideClick to app context
                this.closeLeaveCalendarOnOutsideClick = this.closeLeaveCalendarOnOutsideClick.bind(this);
                // Bind closeLeaveUpdateCalendarOnOutsideClick to app context
                this.closeLeaveUpdateCalendarOnOutsideClick = this.closeLeaveUpdateCalendarOnOutsideClick.bind(this);

                // Populate Admin Team Dropdowns
                const teamSelects = ['rosterTeam', 'leaveUpdateTeam'];
                teamSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                CONFIG.TEAMS.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                            select.appendChild(opt);
                        });
                    }
                });

                this.refreshData();
            },

            updateDateDisplay() {
                // Parse date from YYYY-MM-DD format to avoid timezone issues
                const dateParts = this.state.currentDate.split('-');
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                const day = parseInt(dateParts[2]);
                const dateObj = new Date(year, month, day);
                
                const dateDisplay = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                const dateDisplayElement = document.getElementById('dateDisplay');
                if (dateDisplayElement) {
                    dateDisplayElement.textContent = dateDisplay;
                }
            },

            toggleCalendar(e) {
                if (e) {
                    e.stopPropagation();
                }
                const calendar = document.getElementById('calendarDropdown');
                if (calendar.classList.contains('hidden')) {
                    calendar.classList.remove('hidden');
                    this.renderCalendar();
                    // Close calendar when clicking outside
                    setTimeout(() => {
                        document.addEventListener('click', this.closeCalendarOnOutsideClick);
                    }, 100);
                } else {
                    calendar.classList.add('hidden');
                    document.removeEventListener('click', this.closeCalendarOnOutsideClick);
                }
            },

            closeCalendarOnOutsideClick(e) {
                const calendar = document.getElementById('calendarDropdown');
                if (!calendar) return;
                
                const dateButton = calendar.previousElementSibling;
                const isClickInside = calendar.contains(e.target) || (dateButton && dateButton.contains(e.target));
                
                if (!isClickInside) {
                    calendar.classList.add('hidden');
                    document.removeEventListener('click', this.closeCalendarOnOutsideClick);
                }
            },

            renderCalendar() {
                // Parse date from YYYY-MM-DD format to avoid timezone issues
                const dateParts = this.state.currentDate.split('-');
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                const day = parseInt(dateParts[2]);
                const currentDate = new Date(year, month, day);
                
                // Update month/year header
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
                
                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const calendarDays = document.getElementById('calendarDays');
                calendarDays.innerHTML = '';
                
                // Add empty cells for days before month starts
                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'w-8 h-8';
                    calendarDays.appendChild(emptyCell);
                }
                
                // Add day cells
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('button');
                    dayCell.className = 'w-8 h-8 rounded text-sm transition hover:bg-slate-700';
                    
                    const cellDate = new Date(year, month, day);
                    cellDate.setHours(0, 0, 0, 0);
                    
                    // Format date as YYYY-MM-DD to match state format
                    const cellYear = cellDate.getFullYear();
                    const cellMonth = String(cellDate.getMonth() + 1).padStart(2, '0');
                    const cellDay = String(cellDate.getDate()).padStart(2, '0');
                    const cellDateStr = `${cellYear}-${cellMonth}-${cellDay}`;
                    
                    const isToday = cellDate.getTime() === today.getTime();
                    const isSelected = cellDateStr === this.state.currentDate;
                    
                    if (isSelected) {
                        dayCell.className += ' bg-amber-600 text-white font-semibold';
                    } else if (isToday) {
                        dayCell.className += ' bg-slate-700 text-white border-2 border-amber-500';
                    } else {
                        dayCell.className += ' text-slate-300';
                    }
                    
                    dayCell.textContent = day;
                    dayCell.onclick = () => this.selectDate(year, month, day);
                    calendarDays.appendChild(dayCell);
                }
            },

            changeCalendarMonth(direction) {
                // Parse date from YYYY-MM-DD format to avoid timezone issues
                const dateParts = this.state.currentDate.split('-');
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                const day = parseInt(dateParts[2]);
                const currentDate = new Date(year, month, day);
                
                currentDate.setMonth(currentDate.getMonth() + direction);
                
                // Format as YYYY-MM-DD manually
                const yearStr = currentDate.getFullYear();
                const monthStr = String(currentDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(currentDate.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                
                this.state.currentDate = dateStr;
                document.getElementById('datePicker').value = dateStr;
                this.renderCalendar();
            },

            selectDate(year, month, day) {
                // Create date in local timezone
                const selectedDate = new Date(year, month, day);
                // Format as YYYY-MM-DD manually to avoid timezone issues
                const yearStr = selectedDate.getFullYear();
                const monthStr = String(selectedDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(selectedDate.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                
                console.log("selectDate called:", { year, month, day, dateStr });
                
                this.state.currentDate = dateStr;
                document.getElementById('datePicker').value = dateStr;
                this.updateDateDisplay();
                this.toggleCalendar();
                this.refreshData();
            },

            // --- Leave Multi-Date Calendar Functions ---
            
            toggleLeaveCalendar() {
                const calendar = document.getElementById('leaveCalendarContainer');
                if (calendar.classList.contains('hidden')) {
                    calendar.classList.remove('hidden');
                    this.renderLeaveCalendar();
                    // Close calendar when clicking outside
                    setTimeout(() => {
                        document.addEventListener('click', this.closeLeaveCalendarOnOutsideClick);
                    }, 100);
                } else {
                    calendar.classList.add('hidden');
                    document.removeEventListener('click', this.closeLeaveCalendarOnOutsideClick);
                }
            },

            closeLeaveCalendarOnOutsideClick(e) {
                const calendar = document.getElementById('leaveCalendarContainer');
                if (!calendar) return;
                
                const dateDisplay = document.getElementById('leaveDateDisplay');
                const isClickInside = calendar.contains(e.target) || (dateDisplay && dateDisplay.contains(e.target));
                
                if (!isClickInside) {
                    calendar.classList.add('hidden');
                    document.removeEventListener('click', this.closeLeaveCalendarOnOutsideClick);
                }
            },

            renderLeaveCalendar() {
                // Initialize selected dates if not exists
                if (!this.state.selectedLeaveDates) {
                    this.state.selectedLeaveDates = [];
                }
                
                // Use current date or first selected date as base
                let baseDate;
                if (this.state.selectedLeaveDates.length > 0) {
                    const dateParts = this.state.selectedLeaveDates[0].split('-');
                    baseDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                } else {
                    const dateParts = this.state.currentDate.split('-');
                    baseDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                }
                
                // Store current calendar month/year in state
                if (!this.state.leaveCalendarMonth) {
                    this.state.leaveCalendarMonth = baseDate.getMonth();
                    this.state.leaveCalendarYear = baseDate.getFullYear();
                }
                
                const year = this.state.leaveCalendarYear;
                const month = this.state.leaveCalendarMonth;
                
                // Update month/year header
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                document.getElementById('leaveCalendarMonthYear').textContent = `${monthNames[month]} ${year}`;
                
                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const calendar = document.getElementById('leaveCalendar');
                calendar.innerHTML = '';
                
                // Add day headers
                const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayHeaders.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'text-center text-xs font-semibold text-slate-400 py-1';
                    header.textContent = day;
                    calendar.appendChild(header);
                });
                
                // Add empty cells for days before month starts
                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'w-8 h-8';
                    calendar.appendChild(emptyCell);
                }
                
                // Add day cells
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('button');
                    dayCell.type = 'button';
                    dayCell.className = 'w-8 h-8 rounded text-sm transition hover:bg-slate-700';
                    
                    const cellDate = new Date(year, month, day);
                    cellDate.setHours(0, 0, 0, 0);
                    
                    // Format date as YYYY-MM-DD
                    const cellYear = cellDate.getFullYear();
                    const cellMonth = String(cellDate.getMonth() + 1).padStart(2, '0');
                    const cellDay = String(cellDate.getDate()).padStart(2, '0');
                    const cellDateStr = `${cellYear}-${cellMonth}-${cellDay}`;
                    
                    const isToday = cellDate.getTime() === today.getTime();
                    const isSelected = this.state.selectedLeaveDates.includes(cellDateStr);
                    
                    if (isSelected) {
                        dayCell.className += ' bg-amber-600 text-white font-semibold';
                    } else if (isToday) {
                        dayCell.className += ' bg-slate-700 text-white border-2 border-amber-500';
                    } else {
                        dayCell.className += ' text-slate-300';
                    }
                    
                    dayCell.textContent = day;
                    dayCell.onclick = () => this.selectLeaveDate(year, month, day);
                    calendar.appendChild(dayCell);
                }
                
                this.updateLeaveDateDisplay();
            },

            changeLeaveCalendarMonth(direction) {
                if (!this.state.leaveCalendarMonth) {
                    const dateParts = this.state.currentDate.split('-');
                    this.state.leaveCalendarMonth = parseInt(dateParts[1]) - 1;
                    this.state.leaveCalendarYear = parseInt(dateParts[0]);
                }
                
                this.state.leaveCalendarMonth += direction;
                
                // Handle year rollover
                if (this.state.leaveCalendarMonth < 0) {
                    this.state.leaveCalendarMonth = 11;
                    this.state.leaveCalendarYear--;
                } else if (this.state.leaveCalendarMonth > 11) {
                    this.state.leaveCalendarMonth = 0;
                    this.state.leaveCalendarYear++;
                }
                
                this.renderLeaveCalendar();
            },

            selectLeaveDate(year, month, day) {
                // Create date in local timezone
                const selectedDate = new Date(year, month, day);
                // Format as YYYY-MM-DD manually to avoid timezone issues
                const yearStr = selectedDate.getFullYear();
                const monthStr = String(selectedDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(selectedDate.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                
                // Initialize if not exists
                if (!this.state.selectedLeaveDates) {
                    this.state.selectedLeaveDates = [];
                }
                
                // Toggle selection
                const index = this.state.selectedLeaveDates.indexOf(dateStr);
                if (index > -1) {
                    // Remove if already selected
                    this.state.selectedLeaveDates.splice(index, 1);
                } else {
                    // Add if not selected
                    this.state.selectedLeaveDates.push(dateStr);
                }
                
                // Sort dates
                this.state.selectedLeaveDates.sort();
                
                this.renderLeaveCalendar();
            },

            clearLeaveDates() {
                this.state.selectedLeaveDates = [];
                this.renderLeaveCalendar();
            },

            updateLeaveDateDisplay() {
                const selectedDates = this.state.selectedLeaveDates || [];
                const dateText = document.getElementById('leaveDateText');
                const selectedDatesContainer = document.getElementById('leaveSelectedDates');
                const hiddenInput = document.getElementById('leaveDates');
                
                if (selectedDates.length === 0) {
                    dateText.textContent = 'Click to select dates';
                    dateText.className = 'text-slate-400';
                } else {
                    dateText.textContent = `${selectedDates.length} date(s) selected`;
                    dateText.className = 'text-white';
                }
                
                // Update hidden input with comma-separated dates
                hiddenInput.value = selectedDates.join(',');
                
                // Display selected dates as chips
                selectedDatesContainer.innerHTML = '';
                selectedDates.forEach(dateStr => {
                    const dateParts = dateStr.split('-');
                    const dateObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                    const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    const chip = document.createElement('div');
                    chip.className = 'inline-flex items-center gap-1 px-2 py-1 bg-amber-600 text-white text-xs rounded';
                    chip.innerHTML = `
                        <span>${formattedDate}</span>
                        <button type="button" onclick="app.removeLeaveDate('${dateStr}')" class="hover:text-red-200">√ó</button>
                    `;
                    selectedDatesContainer.appendChild(chip);
                });
            },

            removeLeaveDate(dateStr) {
                if (!this.state.selectedLeaveDates) return;
                const index = this.state.selectedLeaveDates.indexOf(dateStr);
                if (index > -1) {
                    this.state.selectedLeaveDates.splice(index, 1);
                    this.renderLeaveCalendar();
                }
            },

            // --- Leave Update Multi-Date Calendar Functions ---
            
            toggleLeaveUpdateCalendar() {
                const calendar = document.getElementById('leaveUpdateCalendarContainer');
                if (calendar.classList.contains('hidden')) {
                    calendar.classList.remove('hidden');
                    this.renderLeaveUpdateCalendar();
                    // Close calendar when clicking outside
                    setTimeout(() => {
                        document.addEventListener('click', this.closeLeaveUpdateCalendarOnOutsideClick);
                    }, 100);
                } else {
                    calendar.classList.add('hidden');
                    document.removeEventListener('click', this.closeLeaveUpdateCalendarOnOutsideClick);
                }
            },

            closeLeaveUpdateCalendarOnOutsideClick(e) {
                const calendar = document.getElementById('leaveUpdateCalendarContainer');
                if (!calendar) return;
                
                const dateDisplay = document.getElementById('leaveUpdateDateDisplay');
                const isClickInside = calendar.contains(e.target) || (dateDisplay && dateDisplay.contains(e.target));
                
                if (!isClickInside) {
                    calendar.classList.add('hidden');
                    document.removeEventListener('click', this.closeLeaveUpdateCalendarOnOutsideClick);
                }
            },

            renderLeaveUpdateCalendar() {
                // Initialize selected dates if not exists
                if (!this.state.selectedLeaveUpdateDates) {
                    this.state.selectedLeaveUpdateDates = [];
                }
                
                // Use current date or first selected date as base
                let baseDate;
                if (this.state.selectedLeaveUpdateDates.length > 0) {
                    const dateParts = this.state.selectedLeaveUpdateDates[0].split('-');
                    baseDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                } else {
                    const dateParts = this.state.currentDate.split('-');
                    baseDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                }
                
                // Store current calendar month/year in state
                if (!this.state.leaveUpdateCalendarMonth) {
                    this.state.leaveUpdateCalendarMonth = baseDate.getMonth();
                    this.state.leaveUpdateCalendarYear = baseDate.getFullYear();
                }
                
                const year = this.state.leaveUpdateCalendarYear;
                const month = this.state.leaveUpdateCalendarMonth;
                
                // Update month/year header
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                document.getElementById('leaveUpdateCalendarMonthYear').textContent = `${monthNames[month]} ${year}`;
                
                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const calendar = document.getElementById('leaveUpdateCalendar');
                calendar.innerHTML = '';
                
                // Add day headers
                const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayHeaders.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'text-center text-xs font-semibold text-slate-400 py-1';
                    header.textContent = day;
                    calendar.appendChild(header);
                });
                
                // Add empty cells for days before month starts
                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'w-8 h-8';
                    calendar.appendChild(emptyCell);
                }
                
                // Add day cells
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('button');
                    dayCell.type = 'button';
                    dayCell.className = 'w-8 h-8 rounded text-sm transition hover:bg-slate-700';
                    
                    const cellDate = new Date(year, month, day);
                    cellDate.setHours(0, 0, 0, 0);
                    
                    // Format date as YYYY-MM-DD
                    const cellYear = cellDate.getFullYear();
                    const cellMonth = String(cellDate.getMonth() + 1).padStart(2, '0');
                    const cellDay = String(cellDate.getDate()).padStart(2, '0');
                    const cellDateStr = `${cellYear}-${cellMonth}-${cellDay}`;
                    
                    const isToday = cellDate.getTime() === today.getTime();
                    const isSelected = this.state.selectedLeaveUpdateDates.includes(cellDateStr);
                    
                    if (isSelected) {
                        dayCell.className += ' bg-amber-600 text-white font-semibold';
                    } else if (isToday) {
                        dayCell.className += ' bg-slate-700 text-white border-2 border-amber-500';
                    } else {
                        dayCell.className += ' text-slate-300';
                    }
                    
                    dayCell.textContent = day;
                    dayCell.onclick = () => this.selectLeaveUpdateDate(year, month, day);
                    calendar.appendChild(dayCell);
                }
                
                this.updateLeaveUpdateDateDisplay();
            },

            changeLeaveUpdateCalendarMonth(direction) {
                if (!this.state.leaveUpdateCalendarMonth) {
                    const dateParts = this.state.currentDate.split('-');
                    this.state.leaveUpdateCalendarMonth = parseInt(dateParts[1]) - 1;
                    this.state.leaveUpdateCalendarYear = parseInt(dateParts[0]);
                }
                
                this.state.leaveUpdateCalendarMonth += direction;
                
                // Handle year rollover
                if (this.state.leaveUpdateCalendarMonth < 0) {
                    this.state.leaveUpdateCalendarMonth = 11;
                    this.state.leaveUpdateCalendarYear--;
                } else if (this.state.leaveUpdateCalendarMonth > 11) {
                    this.state.leaveUpdateCalendarMonth = 0;
                    this.state.leaveUpdateCalendarYear++;
                }
                
                this.renderLeaveUpdateCalendar();
            },

            selectLeaveUpdateDate(year, month, day) {
                // Create date in local timezone
                const selectedDate = new Date(year, month, day);
                // Format as YYYY-MM-DD manually to avoid timezone issues
                const yearStr = selectedDate.getFullYear();
                const monthStr = String(selectedDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(selectedDate.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                
                // Initialize if not exists
                if (!this.state.selectedLeaveUpdateDates) {
                    this.state.selectedLeaveUpdateDates = [];
                }
                
                // Toggle selection
                const index = this.state.selectedLeaveUpdateDates.indexOf(dateStr);
                if (index > -1) {
                    // Remove if already selected
                    this.state.selectedLeaveUpdateDates.splice(index, 1);
                } else {
                    // Add if not selected
                    this.state.selectedLeaveUpdateDates.push(dateStr);
                }
                
                // Sort dates
                this.state.selectedLeaveUpdateDates.sort();
                
                this.renderLeaveUpdateCalendar();
            },

            clearLeaveUpdateDates() {
                this.state.selectedLeaveUpdateDates = [];
                this.renderLeaveUpdateCalendar();
            },

            updateLeaveUpdateDateDisplay() {
                const selectedDates = this.state.selectedLeaveUpdateDates || [];
                const dateText = document.getElementById('leaveUpdateDateText');
                const selectedDatesContainer = document.getElementById('leaveUpdateSelectedDates');
                const hiddenInput = document.getElementById('leaveUpdateDates');
                
                if (selectedDates.length === 0) {
                    dateText.textContent = 'Click to select dates';
                    dateText.className = 'text-slate-400';
                } else {
                    dateText.textContent = `${selectedDates.length} date(s) selected`;
                    dateText.className = 'text-white';
                }
                
                // Update hidden input with comma-separated dates
                hiddenInput.value = selectedDates.join(',');
                
                // Display selected dates as chips
                selectedDatesContainer.innerHTML = '';
                selectedDates.forEach(dateStr => {
                    const dateParts = dateStr.split('-');
                    const dateObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                    const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    const chip = document.createElement('div');
                    chip.className = 'inline-flex items-center gap-1 px-2 py-1 bg-amber-600 text-white text-xs rounded';
                    chip.innerHTML = `
                        <span>${formattedDate}</span>
                        <button type="button" onclick="app.removeLeaveUpdateDate('${dateStr}')" class="hover:text-red-200">√ó</button>
                    `;
                    selectedDatesContainer.appendChild(chip);
                });
            },

            removeLeaveUpdateDate(dateStr) {
                if (!this.state.selectedLeaveUpdateDates) return;
                const index = this.state.selectedLeaveUpdateDates.indexOf(dateStr);
                if (index > -1) {
                    this.state.selectedLeaveUpdateDates.splice(index, 1);
                    this.renderLeaveUpdateCalendar();
                }
            },

            toggleAdmin() {
                this.state.adminMode = !this.state.adminMode;
                const panel = document.getElementById('adminPanel');
                const btn = document.getElementById('adminToggleBtn');
                const toggleText = document.getElementById('adminToggleText');
                const toggleIcon = document.getElementById('adminToggleIcon');
                
                if (this.state.adminMode) {
                    panel.classList.remove('hidden');
                    toggleText.textContent = "Exit Admin";
                    toggleIcon.textContent = "√ó";
                    btn.classList.remove('bg-slate-700');
                    btn.classList.add('bg-red-600', 'hover:bg-red-700');
                } else {
                    panel.classList.add('hidden');
                    toggleText.textContent = "Admin Mode";
                    toggleIcon.textContent = "üõ°Ô∏è";
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.classList.add('bg-slate-700', 'hover:bg-slate-600');
                }
            },

            async refreshFormulas() {
                // Check if authenticated
                if (!this.state.adminEmail || !this.state.adminPassword) {
                    this.showPasswordModal('refreshFormulas');
                    return;
                }
                
                const btn = document.getElementById('refreshFormulasBtn');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.textContent = '‚è≥ Refreshing...';
                
                try {
                    const params = new URLSearchParams();
                    params.append("action", "refreshFormulas");
                    params.append("email", this.state.adminEmail);
                    params.append("password", this.state.adminPassword);
                    const url = `${CONFIG.SCRIPT_URL}?${params.toString()}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    this.toast('‚úÖ Formulas refreshed! Available counts for combined teams (CFD Night + VE) have been updated.', 'success');
                    
                    // Refresh the dashboard to show updated values
                    await this.refreshData();
                } catch (err) {
                    console.error("Refresh formulas error:", err);
                    this.toast(`‚ùå Failed to refresh formulas: ${err.message}`, 'error');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.textContent = originalText;
                }
            },

            async refreshData() {
                this.showLoader(true, "Syncing roster...");
                try {
                    const url = `${CONFIG.SCRIPT_URL}?action=summary&date=${this.state.currentDate}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    this.renderDashboard(data);
                } catch (err) {
                    console.error("Refresh error:", err);
                    this.toast(`Failed to load data: ${err.message}`, "error");
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('teamGrid').innerHTML = '';
                } finally {
                    this.showLoader(false);
                }
            },

            renderDashboard(data) {
                const grid = document.getElementById('teamGrid');
                grid.innerHTML = '';
                
                if (data.teams.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }
                document.getElementById('emptyState').classList.add('hidden');

                // Calculate summary statistics
                let totalAvailableAgents = 0;
                let teamsOK = 0;
                let teamsShortage = 0;
                let totalRequired = 0;
                let totalAvailable = 0;

                data.teams.forEach(team => {
                    totalAvailableAgents += team.available;
                    totalAvailable += team.available;
                    totalRequired += team.required;
                    if (team.shortage) {
                        teamsShortage++;
                    } else {
                        teamsOK++;
                    }
                });

                const coverage = totalRequired > 0 ? Math.round((totalAvailable / totalRequired) * 100) : 0;

                // Update summary statistics
                document.getElementById('statTotalAgents').textContent = totalAvailableAgents;
                document.getElementById('statTeamsOK').textContent = teamsOK;
                document.getElementById('statShortages').textContent = teamsShortage;
                document.getElementById('statCoverage').textContent = coverage + '%';
                
                // Update Total Agent on Leave
                document.getElementById('statTotalOnLeave').textContent = data.totalAgentOnLeave || 0;

                // Update date display
                this.updateDateDisplay();

                // Render team cards
                data.teams.forEach(team => {
                    const isShortage = team.shortage;
                    const card = document.createElement('div');
                    card.className = "bg-slate-800 border border-slate-700 rounded-lg p-6 hover:border-slate-600 transition cursor-pointer " + 
                                    (isShortage ? "card-border-shortage" : "card-border-ok");
                    
                    // Build shift-specific availability notes
                    let shiftNotes = "";
                    if (team.shiftAvailability && Object.keys(team.shiftAvailability).length > 0) {
                        shiftNotes = '<div class="mt-4 pt-4 border-t border-slate-700 space-y-2">';
                        // Sort shifts for consistent display
                        const sortedShifts = Object.entries(team.shiftAvailability).sort((a, b) => {
                            return a[0].localeCompare(b[0]);
                        });
                        sortedShifts.forEach(([shift, data]) => {
                            const available = data.available !== undefined ? data.available : 0;
                            const required = data.required !== undefined ? data.required : 0;
                            if (available > 0 || required > 0) {
                                const isShort = available < required;
                                shiftNotes += `<div class="flex items-center justify-between text-sm">`;
                                shiftNotes += `<div class="flex items-center gap-2">`;
                                shiftNotes += `<svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                                shiftNotes += `<span class="text-slate-300">${shift}</span>`;
                                shiftNotes += `</div>`;
                                shiftNotes += `<span class="font-semibold ${isShort ? 'text-red-400' : 'text-white'}">${available} / ${required}</span>`;
                                shiftNotes += `</div>`;
                            }
                        });
                        shiftNotes += '</div>';
                    }
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-white text-lg leading-tight">${team.team}</h3>
                            <span class="text-xs font-semibold px-2 py-1 rounded flex items-center gap-1 ${isShortage ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
                                ${isShortage ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg> Shortage' : '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> OK'}
                            </span>
                        </div>
                        <div class="mb-4">
                            <p class="text-3xl font-bold text-white mb-1">Available ${team.available}</p>
                            <p class="text-sm text-slate-400">Total / Required <span class="text-white font-semibold">${team.total} / ${team.required}</span></p>
                            </div>
                        <div class="flex justify-between text-sm text-slate-400 mb-4">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span>Off: ${team.offDay}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <span>Leave: ${team.onLeave}</span>
                        </div>
                        </div>
                        ${shiftNotes}
                    `;
                    
                    // Handle merged team click - show both teams
                    if (team.team.includes(" / ")) {
                        card.onclick = () => {
                            this.loadTeamDetails(team.team);
                        };
                    } else {
                    card.onclick = () => this.loadTeamDetails(team.team);
                    }
                    grid.appendChild(card);
                });
            },

            changeDate(days) {
                const datePicker = document.getElementById('datePicker');
                const currentDate = new Date(this.state.currentDate + 'T00:00:00');
                currentDate.setDate(currentDate.getDate() + days);
                this.state.currentDate = currentDate.toISOString().split('T')[0];
                datePicker.value = this.state.currentDate;
                this.updateDateDisplay();
                this.refreshData();
            },

            async loadTeamDetails(teamName) {
                this.showLoader(true, "Loading agents...");
                this.state.currentTeam = teamName;
                
                try {
                    const url = `${CONFIG.SCRIPT_URL}?action=teamDetails&date=${this.state.currentDate}&team=${encodeURIComponent(teamName)}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    document.getElementById('modalTeamTitle').textContent = data.team;
                    const list = document.getElementById('agentList');
                    list.innerHTML = '';
                    
                    if (!data.agents || data.agents.length === 0) {
                        list.innerHTML = '<li class="py-4 text-center text-slate-400">No agents found for this team on this date.</li>';
                    } else {
                    data.agents.forEach(agent => {
                            // Escape quotes in agent name for onclick
                            const safeName = agent.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                            const leaveType = agent.onLeave ? (agent.leaveType || '') : '';
                            
                        let statusBadge = '';
                            if (agent.onLeave) {
                                statusBadge = `<span class="ml-2 px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-400 text-xs">Leave (${agent.leaveType || 'N/A'})</span>`;
                            } else if (agent.isOffDay) {
                                statusBadge = '<span class="ml-2 px-2 py-0.5 rounded-full text-xs" style="background-color: #F6B26B; color: #7C2D12;">Off Day</span>';
                            }
                            
                            if (agent.isTemporary) {
                                statusBadge += `<span class="ml-2 px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 text-xs">Temporary</span>`;
                            }
                        
                        const li = document.createElement('li');
                        li.className = "py-3 flex justify-between items-center";
                            
                            // Build action buttons
                            let actionButtons = '';
                            if (agent.isTemporary) {
                                actionButtons = `
                                    <div class="flex gap-2">
                                        <button onclick="app.returnTemporaryAgent('${safeName}')" class="px-3 py-1 bg-amber-600 text-white text-sm rounded hover:bg-amber-700 font-medium">
                                            Return
                                        </button>
                                        <button onclick="app.prepLeave('${safeName}', '${leaveType}')" class="text-blue-400 text-sm hover:text-blue-300 hover:underline font-medium">
                                            ${agent.onLeave ? 'Edit Leave' : '+ Leave'}
                                        </button>
                                    </div>
                                `;
                            } else {
                                actionButtons = `
                                    <button onclick="app.prepLeave('${safeName}', '${leaveType}')" class="text-blue-400 text-sm hover:text-blue-300 hover:underline font-medium">
                                        ${agent.onLeave ? 'Edit Leave' : '+ Leave'}
                                    </button>
                                `;
                            }
                            
                            // Style the shift text - use orange for Off Day
                            const shiftDisplay = agent.isOffDay 
                                ? `<span class="px-2 py-0.5 rounded text-sm font-medium" style="background-color: #F6B26B; color: #7C2D12;">Off Day</span>`
                                : `<span class="text-sm text-slate-400">${agent.shift || '--'}</span>`;
                            
                        li.innerHTML = `
                            <div>
                                    <p class="font-medium text-white">${agent.name} ${statusBadge}</p>
                                    <p class="mt-1">${shiftDisplay}</p>
                            </div>
                                ${actionButtons}
                        `;
                        list.appendChild(li);
                    });
                    }
                    
                    this.openModal('detailModal');
                } catch (err) {
                    console.error("Team details error:", err);
                    this.toast(`Error loading team details: ${err.message}`, "error");
                } finally {
                    this.showLoader(false);
                }
            },

            // --- Leave Management ---

            handleLeaveTypeChange() {
                const leaveType = document.getElementById('leaveType').value;
                const halfDayContainer = document.getElementById('halfDayOptionContainer');
                if (leaveType === "Half Day") {
                    halfDayContainer.classList.remove('hidden');
                } else {
                    halfDayContainer.classList.add('hidden');
                }
            },

            handleLeaveUpdateTypeChange() {
                const leaveType = document.getElementById('leaveUpdateType').value;
                const halfDayContainer = document.getElementById('halfDayUpdateOptionContainer');
                if (leaveType === "Half Day") {
                    halfDayContainer.classList.remove('hidden');
                } else {
                    halfDayContainer.classList.add('hidden');
                }
            },

            prepLeave(agentName, currentLeaveType) {
                this.state.currentAgent = agentName;
                document.getElementById('leaveTeam').value = this.state.currentTeam;
                document.getElementById('leaveAgentDisplay').value = agentName;
                document.getElementById('leaveAgentName').value = agentName;
                
                // Parse leave type and half-day option if it's a half-day leave
                let leaveType = currentLeaveType || "Sick Leave";
                let halfDayOption = "";
                if (currentLeaveType && currentLeaveType.includes("Half Day")) {
                    // Check if it includes half-day option (e.g., "Half Day (1st Half)")
                    const match = currentLeaveType.match(/\(([^)]+)\)/);
                    if (match) {
                        leaveType = "Half Day";
                        halfDayOption = match[1];
                    } else {
                        leaveType = "Half Day";
                    }
                }
                
                document.getElementById('leaveType').value = leaveType;
                document.getElementById('leaveNotes').value = "";
                
                // Show/hide half-day option based on leave type
                this.handleLeaveTypeChange();
                if (halfDayOption) {
                    document.getElementById('halfDayOption').value = halfDayOption;
                }
                
                // Initialize leave calendar state
                if (!this.state.selectedLeaveDates) {
                    this.state.selectedLeaveDates = [];
                }
                // Reset calendar month to current date
                const dateParts = this.state.currentDate.split('-');
                this.state.leaveCalendarMonth = parseInt(dateParts[1]) - 1;
                this.state.leaveCalendarYear = parseInt(dateParts[0]);
                
                // If editing existing leave, pre-select the current date
                if (currentLeaveType) {
                    if (!this.state.selectedLeaveDates.includes(this.state.currentDate)) {
                        this.state.selectedLeaveDates = [this.state.currentDate];
                    }
                } else {
                    // For new leave, start with empty selection
                    this.state.selectedLeaveDates = [];
                }
                
                this.updateLeaveDateDisplay();
                
                // Show/hide Cancel Leave button and update title based on whether leave exists
                const cancelBtn = document.getElementById('cancelLeaveBtn');
                const modalTitle = document.getElementById('leaveModalTitle');
                if (currentLeaveType) {
                    cancelBtn.classList.remove('hidden');
                    modalTitle.textContent = "Edit Leave";
                    this.state.isEditingLeave = true;
                } else {
                    cancelBtn.classList.add('hidden');
                    modalTitle.textContent = "Apply Leave";
                    this.state.isEditingLeave = false;
                }
                
                this.openModal('leaveModal');
            },

            async submitLeave() {
                // Validate that at least one date is selected
                const selectedDates = this.state.selectedLeaveDates || [];
                if (selectedDates.length === 0) {
                    this.toast("Please select at least one date", "error");
                    return;
                }
                
                // Disable and gray out the submit button
                const submitBtn = document.getElementById('leaveSubmitBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
                
                this.showLoader(true, `Saving ${selectedDates.length} leave record(s)...`);
                
                // Send each date as a separate request
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                for (const date of selectedDates) {
                    let leaveType = document.getElementById('leaveType').value;
                    // If Half Day, append the half-day option
                    if (leaveType === "Half Day") {
                        const halfDayOption = document.getElementById('halfDayOption').value;
                        leaveType = `Half Day (${halfDayOption})`;
                    }
                    
                    const payload = {
                        action: "addLeave",
                        date: date,
                        team: document.getElementById('leaveTeam').value,
                        name: document.getElementById('leaveAgentName').value,
                        type: leaveType,
                        notes: document.getElementById('leaveNotes').value
                    };

                    try {
                        // Use GET request with URL parameters to avoid CORS issues
                        const params = new URLSearchParams();
                        Object.keys(payload).forEach(key => {
                            params.append(key, payload[key]);
                        });
                        
                        const response = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                            method: "GET"
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                            errors.push(`${date}: ${result.error || "Unknown error"}`);
                        }
                    } catch (err) {
                        errorCount++;
                        errors.push(`${date}: ${err.message}`);
                        console.error("Leave submission error for date " + date + ":", err);
                    }
                }
                
                // Show summary message
                if (errorCount === 0) {
                    this.toast(`Successfully added ${successCount} leave record(s)`, "success");
                    this.closeModal('leaveModal');
                    // Refresh details
                    this.loadTeamDetails(this.state.currentTeam);
                    // Refresh dashboard background
                    this.refreshData();
                } else if (successCount > 0) {
                    this.toast(`Added ${successCount} leave record(s), but ${errorCount} failed. Check console for details.`, "warning");
                    console.error("Leave submission errors:", errors);
                } else {
                    this.toast(`Failed to add leave records. Check console for details.`, "error");
                    console.error("Leave submission errors:", errors);
                }
                
                this.showLoader(false);
                // Re-enable and restore button color
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            },

            async returnTemporaryAgent(agentName) {
                if (!confirm(`Are you sure you want to return ${agentName} to their original team? This will remove the temporary team change.`)) {
                    return;
                }

                this.showLoader(true, "Returning agent...");

                try {
                    const params = new URLSearchParams();
                    params.append("action", "returnTemporaryAgent");
                    params.append("date", this.state.currentDate);
                    params.append("team", this.state.currentTeam || "");
                    params.append("name", agentName);
                    
                    console.log("returnTemporaryAgent: Sending request with:");
                    console.log("  Agent Name: '" + agentName + "'");
                    console.log("  Current Team: '" + (this.state.currentTeam || "") + "'");
                    console.log("  Date: '" + this.state.currentDate + "'");
                    console.log("  Full URL: " + CONFIG.SCRIPT_URL + "?" + params.toString());
                    
                    const response = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                        method: "GET"
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.ok) {
                        this.toast("Agent returned to original team successfully");
                        this.closeModal('detailModal');
                        this.loadTeamDetails(this.state.currentTeam); // Refresh team details
                        this.refreshData(); // Refresh dashboard
                    } else {
                        throw new Error(result.error || "Unknown error");
                    }
                } catch (err) {
                    console.error("Return agent error:", err);
                    this.toast(`Failed to return agent: ${err.message}`, "error");
                } finally {
                    this.showLoader(false);
                }
            },

            async cancelLeave() {
                if (!confirm(`Are you sure you want to cancel the leave for ${this.state.currentAgent} on ${this.state.currentDate}?`)) {
                    return;
                }
                
                this.showLoader(true, "Cancelling leave...");
                
                try {
                    // Use GET request with URL parameters to avoid CORS issues
                    const params = new URLSearchParams();
                    params.append("action", "deleteLeave");
                    params.append("date", this.state.currentDate);
                    params.append("team", this.state.currentTeam);
                    params.append("name", this.state.currentAgent);
                    
                    const response = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                        method: "GET"
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.ok) {
                        this.toast("Leave cancelled successfully");
                        this.closeModal('leaveModal');
                        // Refresh details
                        this.loadTeamDetails(this.state.currentTeam);
                        // Refresh dashboard background
                        this.refreshData();
                    } else {
                        throw new Error(result.error || "Unknown error");
                    }
                } catch (err) {
                    console.error("Cancel leave error:", err);
                    this.toast(`Failed to cancel leave: ${err.message}`, "error");
                } finally {
                    this.showLoader(false);
                }
            },

            // --- Password Authentication ---
            
            showPasswordModal(action) {
                // Store the action to perform after authentication
                this.state.pendingAction = action;
                // Clear previous inputs
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                document.getElementById('passwordError').classList.add('hidden');
                document.getElementById('passwordError').textContent = '';
                this.openModal('passwordModal');
            },

            async submitPassword() {
                const email = document.getElementById('adminEmail').value.trim();
                const password = document.getElementById('adminPassword').value;
                
                if (!email || !password) {
                    document.getElementById('passwordError').textContent = 'Please enter both email and password';
                    document.getElementById('passwordError').classList.remove('hidden');
                    return;
                }
                
                // Disable submit button
                const submitBtn = document.getElementById('passwordSubmitBtn');
                submitBtn.disabled = true;
                submitBtn.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                this.showLoader(true, "Authenticating...");
                
                try {
                    const params = new URLSearchParams();
                    params.append("action", "authenticate");
                    params.append("email", email);
                    params.append("password", password);
                    
                    const response = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                        method: "GET"
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.authenticated) {
                        // Authentication successful - store credentials for this session
                        this.state.adminEmail = email;
                        this.state.adminPassword = password;
                        
                        // Close modal and perform the pending action
                        this.closeModal('passwordModal');
                        const pendingAction = this.state.pendingAction;
                        this.state.pendingAction = null;
                        
                        // Execute the pending action
                        if (pendingAction === 'updateRoster') {
                            this.openRosterEditModal();
                        } else if (pendingAction === 'manageAgents') {
                            this.openAgentManageModal();
                        } else if (pendingAction === 'refreshFormulas') {
                            this.refreshFormulas();
                        }
                    } else {
                        throw new Error(result.error || "Invalid email or password");
                    }
                } catch (err) {
                    console.error("Authentication error:", err);
                    document.getElementById('passwordError').textContent = err.message || "Authentication failed. Please check your credentials.";
                    document.getElementById('passwordError').classList.remove('hidden');
                } finally {
                    this.showLoader(false);
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-amber-600', 'hover:bg-amber-700');
                }
            },

            // --- Roster Edit (Admin) ---
            
            openRosterEditModal() {
                // Reset all fields
                document.getElementById('rosterTeam').value = "";
                document.getElementById('rosterAgent').innerHTML = '<option value="">Select Team First</option>';
                document.getElementById('rosterShift').value = "";
                document.getElementById('rosterFromDate').value = "";
                document.getElementById('rosterToDate').value = "";
                document.getElementById('rosterStartDate').value = "";
                document.getElementById('rosterNewTeam').value = "";
                document.getElementById('rosterPermanentNewTeam').value = "";
                document.getElementById('rosterDayOffOne').value = "";
                document.getElementById('rosterDayOffTwo').value = "";
                
                // Set default to temporary
                document.querySelector('input[name="changeType"][value="temporary"]').checked = true;
                this.toggleChangeType();
                
                // Populate new team dropdowns
                const newTeamSelect = document.getElementById('rosterNewTeam');
                const permanentNewTeamSelect = document.getElementById('rosterPermanentNewTeam');
                
                newTeamSelect.innerHTML = '<option value="">Select New Team</option>';
                permanentNewTeamSelect.innerHTML = '<option value="">Keep Current Team</option>';
                
                CONFIG.TEAMS.forEach(t => {
                    // For temporary changes
                    const opt1 = document.createElement('option');
                    opt1.value = t;
                    opt1.textContent = t;
                    newTeamSelect.appendChild(opt1);
                    
                    // For permanent changes
                    const opt2 = document.createElement('option');
                    opt2.value = t;
                    opt2.textContent = t;
                    permanentNewTeamSelect.appendChild(opt2);
                });
                
                this.openModal('rosterEditModal');
            },

            toggleChangeType() {
                const changeType = document.querySelector('input[name="changeType"]:checked').value;
                const tempFields = document.getElementById('temporaryFields');
                const permFields = document.getElementById('permanentFields');
                
                if (changeType === 'temporary') {
                    tempFields.classList.remove('hidden');
                    permFields.classList.add('hidden');
                } else {
                    tempFields.classList.add('hidden');
                    permFields.classList.remove('hidden');
                }
            },

            selectShiftTime(shiftTime, buttonElement) {
                document.getElementById('rosterShift').value = shiftTime;
                // Visual feedback - highlight selected button
                document.querySelectorAll('#rosterEditModal button[onclick*="selectShiftTime"]').forEach(btn => {
                    btn.classList.remove('bg-amber-600', 'text-white', 'border-amber-500');
                    btn.classList.add('border-slate-600', 'bg-slate-700', 'text-slate-300');
                });
                if (buttonElement) {
                    buttonElement.classList.add('bg-amber-600', 'text-white', 'border-amber-500');
                    buttonElement.classList.remove('border-slate-600', 'bg-slate-700', 'text-slate-300');
                }
            },

            async populateRosterAgents() {
                const team = document.getElementById('rosterTeam').value;
                const agentSelect = document.getElementById('rosterAgent');
                agentSelect.innerHTML = '<option value="">Loading...</option>';
                
                if (!team) {
                    agentSelect.innerHTML = '<option value="">Select Team First</option>';
                    return;
                }

                // Try to fetch from backend first
                try {
                    const url = `${CONFIG.SCRIPT_URL}?action=getAgents&team=${encodeURIComponent(team)}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.agents && data.agents.length > 0) {
                        agentSelect.innerHTML = '<option value="">Select Agent</option>';
                        data.agents.forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            agentSelect.appendChild(opt);
                        });
                        return;
                    }
                } catch (err) {
                    console.log("Could not fetch agents from backend, using config list");
                }

                // Fallback to hardcoded master list
                agentSelect.innerHTML = '<option value="">Select Agent</option>';
                const agents = CONFIG.AGENT_MASTER_LIST[team];

                if (agents && agents.length > 0) {
                    agents.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        agentSelect.appendChild(opt);
                    });
                } else {
                    const opt = document.createElement('option');
                    opt.textContent = "No agents found";
                    agentSelect.appendChild(opt);
                }
            },

            async submitRosterUpdate() {
                // Check if authenticated
                if (!this.state.adminEmail || !this.state.adminPassword) {
                    this.closeModal('rosterEditModal');
                    this.showPasswordModal('updateRoster');
                    return;
                }
                
                const team = document.getElementById('rosterTeam').value;
                const name = document.getElementById('rosterAgent').value;
                const shift = document.getElementById('rosterShift').value;
                const changeType = document.querySelector('input[name="changeType"]:checked').value;
                const dayOffOne = document.getElementById('rosterDayOffOne').value;
                const dayOffTwo = document.getElementById('rosterDayOffTwo').value;
                
                if (!team || !name) {
                    this.toast("Please select both team and agent", "error");
                    return;
                }
                
                if (!shift) {
                    this.toast("Please select or enter shift time", "error");
                    return;
                }
                
                // Validate temporary change fields
                if (changeType === 'temporary') {
                    const fromDate = document.getElementById('rosterFromDate').value;
                    const toDate = document.getElementById('rosterToDate').value;
                    const newTeam = document.getElementById('rosterNewTeam').value;
                    
                    if (!fromDate || !toDate) {
                        this.toast("Please select both from and to dates for temporary change", "error");
                        return;
                    }
                    
                    if (new Date(fromDate) > new Date(toDate)) {
                        this.toast("From date must be before to date", "error");
                        return;
                    }
                    
                    if (!newTeam) {
                        this.toast("Please select a new team for temporary assignment", "error");
                        return;
                    }
                } else {
                    // Permanent change
                    const startDate = document.getElementById('rosterStartDate').value;
                    if (!startDate) {
                        this.toast("Please select a starting date for permanent change", "error");
                        return;
                    }
                    // newTeam is optional for permanent - can be empty to just update shift
                }
                
                // Disable and gray out the submit button
                const submitBtn = document.getElementById('rosterSubmitBtn');
                const originalBg = submitBtn.classList.contains('bg-amber-600') ? 'bg-amber-600' : '';
                const originalHover = submitBtn.classList.contains('hover:bg-amber-700') ? 'hover:bg-amber-700' : '';
                submitBtn.disabled = true;
                submitBtn.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                this.showLoader(true, "Updating roster...");
                const payload = {
                    action: "updateRoster",
                    team: team,
                    name: name,
                    shift: shift,
                    changeType: changeType,
                    dayOffOne: dayOffOne || "",
                    dayOffTwo: dayOffTwo || ""
                };
                
                // Add type-specific fields
                if (changeType === 'temporary') {
                    payload.fromDate = document.getElementById('rosterFromDate').value;
                    payload.toDate = document.getElementById('rosterToDate').value;
                    payload.newTeam = document.getElementById('rosterNewTeam').value;
                } else {
                    payload.startDate = document.getElementById('rosterStartDate').value;
                    const permanentNewTeamElement = document.getElementById('rosterPermanentNewTeam');
                    payload.newTeam = permanentNewTeamElement ? permanentNewTeamElement.value : "";
                    console.log("Permanent change - newTeam element:", permanentNewTeamElement);
                    console.log("Permanent change - newTeam value:", payload.newTeam);
                    
                    // IMPORTANT: Alert user if no team is selected for team change
                    if (!payload.newTeam) {
                        console.log("WARNING: No new team selected - only shift times will be updated!");
                    }
                }
                
                // Debug: Log the full payload before sending
                console.log("=== Roster Update Payload ===");
                console.log("changeType:", changeType);
                console.log("team (current):", payload.team);
                console.log("name:", payload.name);
                console.log("newTeam:", payload.newTeam);
                console.log("shift:", payload.shift);
                console.log("Full payload:", JSON.stringify(payload));
                
                // Show clear message about what will happen
                if (changeType === 'permanent' && payload.newTeam && payload.newTeam !== payload.team) {
                    console.log("‚úÖ TEAM CHANGE: Will move " + payload.name + " from '" + payload.team + "' to '" + payload.newTeam + "'");
                } else if (changeType === 'permanent' && !payload.newTeam) {
                    console.log("‚ö†Ô∏è NO TEAM CHANGE: Only shift times will be updated (no new team selected in dropdown)");
                } else if (changeType === 'permanent' && payload.newTeam === payload.team) {
                    console.log("‚ö†Ô∏è SAME TEAM SELECTED: Only shift times will be updated");
                }

                try {
                    // Use GET request with URL parameters to avoid CORS issues
                    const params = new URLSearchParams();
                    Object.keys(payload).forEach(key => {
                        params.append(key, payload[key]);
                    });
                    // Add authentication credentials
                    params.append("email", this.state.adminEmail);
                    params.append("password", this.state.adminPassword);
                    
                    console.log("URL params:", params.toString());
                    
                    const res = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                        method: "GET"
                    });
                    
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    
                    const data = await res.json();
                    
                    if (data.ok) {
                        this.toast(changeType === 'temporary' ? "Temporary team change applied successfully" : "Permanent team change applied successfully");
                        this.closeModal('rosterEditModal');
                        this.refreshData();
                    } else {
                        throw new Error(data.error || "Update failed");
                    }
                } catch (err) {
                    console.error("Roster update error:", err);
                    this.toast(`Update failed: ${err.message}`, "error");
                } finally {
                    this.showLoader(false);
                    // Re-enable and restore button color
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        submitBtn.classList.add('bg-amber-600', 'hover:bg-amber-700');
                    }
                }
            },

            // --- Leave Update (Admin) ---

            openLeaveUpdateModal() {
                document.getElementById('leaveUpdateTeam').value = "";
                document.getElementById('leaveUpdateAgent').innerHTML = '<option value="">Select Team First</option>';
                document.getElementById('leaveUpdateType').value = "Sick Leave";
                document.getElementById('leaveUpdateNotes').value = "";
                
                // Hide half-day option container initially
                document.getElementById('halfDayUpdateOptionContainer').classList.add('hidden');
                
                // Initialize leave update calendar state
                if (!this.state.selectedLeaveUpdateDates) {
                    this.state.selectedLeaveUpdateDates = [];
                }
                // Reset calendar month to current date
                const dateParts = this.state.currentDate.split('-');
                this.state.leaveUpdateCalendarMonth = parseInt(dateParts[1]) - 1;
                this.state.leaveUpdateCalendarYear = parseInt(dateParts[0]);
                
                this.updateLeaveUpdateDateDisplay();
                
                this.openModal('leaveUpdateModal');
            },

            async populateLeaveUpdateAgents() {
                const team = document.getElementById('leaveUpdateTeam').value;
                const agentSelect = document.getElementById('leaveUpdateAgent');
                agentSelect.innerHTML = '<option value="">Loading...</option>';
                
                if (!team) {
                    agentSelect.innerHTML = '<option value="">Select Team First</option>';
                    return;
                }

                // Try to fetch from backend first
                try {
                    const url = `${CONFIG.SCRIPT_URL}?action=getAgents&team=${encodeURIComponent(team)}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.agents && data.agents.length > 0) {
                        agentSelect.innerHTML = '<option value="">Select Agent</option>';
                        data.agents.forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            agentSelect.appendChild(opt);
                        });
                        return;
                    }
                } catch (err) {
                    console.log("Could not fetch agents from backend, using config list");
                }

                // Fallback to hardcoded list
                agentSelect.innerHTML = '<option value="">Select Agent</option>';
                const agents = CONFIG.AGENT_MASTER_LIST[team];
                if (agents && agents.length > 0) {
                    agents.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        agentSelect.appendChild(opt);
                    });
                }
            },

            async submitLeaveUpdate() {
                const team = document.getElementById('leaveUpdateTeam').value;
                const name = document.getElementById('leaveUpdateAgent').value;
                const selectedDates = this.state.selectedLeaveUpdateDates || [];
                
                if (!team || !name) {
                    this.toast("Please select team and agent", "error");
                    return;
                }
                
                if (selectedDates.length === 0) {
                    this.toast("Please select at least one date", "error");
                    return;
                }
                
                // Disable and gray out the submit button
                const submitBtn = document.querySelector('#leaveUpdateForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                    submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
                
                this.showLoader(true, `Saving ${selectedDates.length} leave record(s)...`);
                
                // Send each date as a separate request
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                for (const date of selectedDates) {
                    let leaveType = document.getElementById('leaveUpdateType').value;
                    // If Half Day, append the half-day option
                    if (leaveType === "Half Day") {
                        const halfDayOption = document.getElementById('halfDayUpdateOption').value;
                        leaveType = `Half Day (${halfDayOption})`;
                    }
                    
                    const payload = {
                        action: "addLeave",
                        date: date,
                        team: team,
                        name: name,
                        type: leaveType,
                        notes: document.getElementById('leaveUpdateNotes').value
                    };

                    try {
                        // Use GET request with URL parameters to avoid CORS issues
                        const params = new URLSearchParams();
                        Object.keys(payload).forEach(key => {
                            params.append(key, payload[key]);
                        });
                        
                        const response = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                            method: "GET"
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                            errors.push(`${date}: ${result.error || "Unknown error"}`);
                        }
                    } catch (err) {
                        errorCount++;
                        errors.push(`${date}: ${err.message}`);
                        console.error("Leave update error for date " + date + ":", err);
                    }
                }
                
                // Show summary message
                if (errorCount === 0) {
                    this.toast(`Successfully added ${successCount} leave record(s)`, "success");
                    this.closeModal('leaveUpdateModal');
                    this.refreshData();
                } else if (successCount > 0) {
                    this.toast(`Added ${successCount} leave record(s), but ${errorCount} failed. Check console for details.`, "warning");
                    console.error("Leave update errors:", errors);
                } else {
                    this.toast(`Failed to add leave records. Check console for details.`, "error");
                    console.error("Leave update errors:", errors);
                }
                
                this.showLoader(false);
                // Re-enable and restore button color
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-teal-600', 'hover:bg-teal-700');
                }
            },

            // --- Leave List (Admin) ---

            openLeaveListModal() {
                const dateInput = document.getElementById('leaveListDate');
                dateInput.value = this.state.currentDate;
                this.loadLeaveList();
                this.openModal('leaveListModal');
            },

            async loadLeaveList() {
                const date = document.getElementById('leaveListDate').value || this.state.currentDate;
                const tbody = document.getElementById('leaveListBody');
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-slate-400">Loading...</td></tr>';

                try {
                    const url = `${CONFIG.SCRIPT_URL}?action=listLeaves&date=${date}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    tbody.innerHTML = '';
                    
                    if (!data.leaves || data.leaves.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-slate-400">No leaves found for this date.</td></tr>';
                        return;
                    }
                    
                    data.leaves.forEach(leave => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-700";
                        tr.innerHTML = `
                            <td class="px-4 py-3 text-sm text-white">${leave.date}</td>
                            <td class="px-4 py-3 text-sm text-slate-300">${leave.team}</td>
                            <td class="px-4 py-3 text-sm text-slate-300">${leave.name}</td>
                            <td class="px-4 py-3 text-sm text-slate-300">${leave.type}</td>
                            <td class="px-4 py-3 text-sm">
                                <button onclick="app.deleteLeave('${leave.date}', '${leave.team.replace(/'/g, "&#39;")}', '${leave.name.replace(/'/g, "&#39;")}')" 
                                        class="text-red-400 hover:text-red-300 font-medium">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (err) {
                    console.error("Load leave list error:", err);
                    tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center text-red-400">Error: ${err.message}</td></tr>`;
                }
            },

            async deleteLeave(date, team, name) {
                if (!confirm(`Are you sure you want to delete the leave for ${name} on ${date}?`)) {
                    return;
                }
                
                this.showLoader(true, "Deleting leave...");
                
                try {
                    // Use GET request with URL parameters to avoid CORS issues
                    const params = new URLSearchParams();
                    params.append("action", "deleteLeave");
                    params.append("date", date);
                    params.append("team", team);
                    params.append("name", name);
                    
                    const response = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                        method: "GET"
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.ok) {
                        this.toast("Leave deleted successfully");
                        this.loadLeaveList();
                        this.refreshData();
                    } else {
                        throw new Error(result.error || "Unknown error");
                    }
                } catch (err) {
                    console.error("Delete leave error:", err);
                    this.toast(`Failed to delete leave: ${err.message}`, "error");
                } finally {
                    this.showLoader(false);
                }
            },

            // --- Agent Management (Admin) ---

            openAgentManageModal() {
                // Populate team dropdowns
                const addTeamSelect = document.getElementById('addAgentTeam');
                const removeTeamSelect = document.getElementById('removeAgentTeam');
                
                addTeamSelect.innerHTML = '<option value="">Select Team</option>';
                removeTeamSelect.innerHTML = '<option value="">Select Team</option>';
                
                CONFIG.TEAMS.forEach(t => {
                    const opt1 = document.createElement('option');
                    opt1.value = t;
                    opt1.textContent = t;
                    addTeamSelect.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = t;
                    opt2.textContent = t;
                    removeTeamSelect.appendChild(opt2);
                });
                
                // Reset forms
                document.getElementById('addAgentName').value = "";
                document.getElementById('addAgentShift').value = "";
                document.getElementById('removeAgentName').innerHTML = '<option value="">Select Team First</option>';
                
                // Reset weekend day buttons
                document.querySelectorAll('.weekend-day-btn').forEach(btn => {
                    btn.classList.remove('bg-green-600', 'text-white', 'border-green-500');
                    btn.classList.add('border-slate-600', 'bg-slate-700', 'text-slate-300');
                    btn.dataset.selected = 'false';
                });
                
                // Switch to Add tab by default
                this.switchAgentTab('add');
                this.openModal('agentManageModal');
            },

            toggleWeekendDay(dayName, buttonElement) {
                const isSelected = buttonElement.dataset.selected === 'true';
                
                if (isSelected) {
                    // Deselect
                    buttonElement.classList.remove('bg-green-600', 'text-white', 'border-green-500');
                    buttonElement.classList.add('border-slate-600', 'bg-slate-700', 'text-slate-300');
                    buttonElement.dataset.selected = 'false';
                } else {
                    // Select
                    buttonElement.classList.add('bg-green-600', 'text-white', 'border-green-500');
                    buttonElement.classList.remove('border-slate-600', 'bg-slate-700', 'text-slate-300');
                    buttonElement.dataset.selected = 'true';
                }
            },

            switchAgentTab(tab) {
                const addForm = document.getElementById('addAgentForm');
                const removeForm = document.getElementById('removeAgentForm');
                const addTab = document.getElementById('agentAddTab');
                const removeTab = document.getElementById('agentRemoveTab');
                
                if (tab === 'add') {
                    addForm.classList.remove('hidden');
                    removeForm.classList.add('hidden');
                    addTab.classList.add('border-green-500', 'text-green-400');
                    addTab.classList.remove('border-transparent', 'text-slate-400');
                    removeTab.classList.remove('border-red-500', 'text-red-400');
                    removeTab.classList.add('border-transparent', 'text-slate-400');
                } else {
                    addForm.classList.add('hidden');
                    removeForm.classList.remove('hidden');
                    removeTab.classList.add('border-red-500', 'text-red-400');
                    removeTab.classList.remove('border-transparent', 'text-slate-400', 'hover:text-slate-300', 'hover:border-slate-600');
                    addTab.classList.remove('border-green-500', 'text-green-400');
                    addTab.classList.add('border-transparent', 'text-slate-400', 'hover:text-slate-300', 'hover:border-slate-600');
                }
            },

            async loadExistingAgents() {
                const team = document.getElementById('addAgentTeam').value;
                // This is just for reference - we don't need to load existing agents for adding
            },

            async loadAgentsForRemoval() {
                const team = document.getElementById('removeAgentTeam').value;
                const agentSelect = document.getElementById('removeAgentName');
                agentSelect.innerHTML = '<option value="">Loading...</option>';
                
                if (!team) {
                    agentSelect.innerHTML = '<option value="">Select Team First</option>';
                    return;
                }

                try {
                    const url = `${CONFIG.SCRIPT_URL}?action=getAgents&team=${encodeURIComponent(team)}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.agents && data.agents.length > 0) {
                        agentSelect.innerHTML = '<option value="">Select Agent</option>';
                        data.agents.forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            agentSelect.appendChild(opt);
                        });
                        return;
                    }
                } catch (err) {
                    console.log("Could not fetch agents from backend");
                }

                agentSelect.innerHTML = '<option value="">No agents found</option>';
            },

            async addAgent() {
                // Check if authenticated
                if (!this.state.adminEmail || !this.state.adminPassword) {
                    this.closeModal('agentManageModal');
                    this.showPasswordModal('manageAgents');
                    return;
                }
                
                const team = document.getElementById('addAgentTeam').value;
                const name = document.getElementById('addAgentName').value.trim();
                const shift = document.getElementById('addAgentShift').value.trim();
                
                if (!team || !name) {
                    this.toast("Please select a team and enter agent name", "error");
                    return;
                }
                
                if (!shift) {
                    this.toast("Please enter a default shift time", "error");
                    return;
                }
                
                // Get selected weekend days
                const weekendDays = [];
                document.querySelectorAll('.weekend-day-btn').forEach(btn => {
                    if (btn.dataset.selected === 'true') {
                        weekendDays.push(btn.dataset.day);
                    }
                });
                
                // Disable button
                const submitBtn = document.getElementById('addAgentBtn');
                submitBtn.disabled = true;
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                this.showLoader(true, "Adding agent...");
                
                try {
                    const params = new URLSearchParams();
                    params.append("action", "addAgent");
                    params.append("team", team);
                    params.append("name", name);
                    params.append("shift", shift);
                    params.append("weekendDays", weekendDays.join(','));
                    // Add authentication credentials
                    params.append("email", this.state.adminEmail);
                    params.append("password", this.state.adminPassword);
                    
                    const response = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                        method: "GET"
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.ok) {
                        this.toast("Agent added successfully");
                        this.closeModal('agentManageModal');
                        this.refreshData();
                    } else {
                        throw new Error(result.error || "Failed to add agent");
                    }
                } catch (err) {
                    console.error("Add agent error:", err);
                    this.toast(`Failed to add agent: ${err.message}`, "error");
                } finally {
                    this.showLoader(false);
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }
                }
            },

            async removeAgent() {
                // Check if authenticated
                if (!this.state.adminEmail || !this.state.adminPassword) {
                    this.closeModal('agentManageModal');
                    this.showPasswordModal('manageAgents');
                    return;
                }
                
                const team = document.getElementById('removeAgentTeam').value;
                const name = document.getElementById('removeAgentName').value;
                
                if (!team || !name) {
                    this.toast("Please select both team and agent", "error");
                    return;
                }
                
                if (!confirm(`Are you sure you want to remove ${name} from ${team}? This will permanently delete their row from the roster sheet.`)) {
                    return;
                }
                
                // Disable button
                const submitBtn = document.getElementById('removeAgentBtn');
                submitBtn.disabled = true;
                submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                this.showLoader(true, "Removing agent...");
                
                try {
                    const params = new URLSearchParams();
                    params.append("action", "removeAgent");
                    params.append("team", team);
                    params.append("name", name);
                    // Add authentication credentials
                    params.append("email", this.state.adminEmail);
                    params.append("password", this.state.adminPassword);
                    
                    const response = await fetch(CONFIG.SCRIPT_URL + "?" + params.toString(), {
                        method: "GET"
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.ok) {
                        this.toast("Agent removed successfully");
                        this.closeModal('agentManageModal');
                        this.refreshData();
                    } else {
                        throw new Error(result.error || "Failed to remove agent");
                    }
                } catch (err) {
                    console.error("Remove agent error:", err);
                    this.toast(`Failed to remove agent: ${err.message}`, "error");
                } finally {
                    this.showLoader(false);
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    }
                }
            },

            // --- UI Helpers ---

            openModal(id) {
                document.getElementById(id).classList.remove('hidden');
            },
            closeModal(id) {
                document.getElementById(id).classList.add('hidden');
            },
            showLoader(show, text="Loading...") {
                const el = document.getElementById('loaderOverlay');
                const txt = document.getElementById('loaderText');
                txt.textContent = text;
                if (show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            },
            toast(msg, type='success') {
                const el = document.getElementById('toast');
                const txt = document.getElementById('toastMessage');
                
                // Clear any existing timeout
                if (this.toastTimeout) {
                    clearTimeout(this.toastTimeout);
                }
                
                // Remove hidden class and reset position
                el.classList.remove('hidden', 'translate-y-20', 'opacity-0');
                
                // Set message and styling
                txt.textContent = msg;
                const bgColor = type === 'error' ? 'bg-red-600' : 'bg-slate-800';
                el.className = `fixed bottom-4 right-4 px-6 py-3 rounded shadow-lg transform transition-all duration-300 z-50 flex items-center gap-3 ${bgColor} text-white translate-y-0 opacity-100`;
                
                // Hide after 3 seconds
                this.toastTimeout = setTimeout(() => {
                    el.classList.add('translate-y-20', 'opacity-0');
                    // Hide completely after transition animation
                    setTimeout(() => {
                        el.classList.add('hidden');
                    }, 300); // Wait for CSS transition to complete (duration-300 = 300ms)
                }, 3000);
            }
        };

        // Boot
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
